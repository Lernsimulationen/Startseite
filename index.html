<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Textdetektiv: Gott oder Satan? (Profi-Modus)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #d35400;
            --success: #27ae60;
            --error: #c0392b;
            --neutral: #7f8c8d;
            --bg: #fdfbf7;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.08);
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-serif: 'Georgia', 'Times New Roman', serif;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, #fdfbf7 0%, #f4f1ea 100%);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            max-width: 850px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
            border-top: 6px solid var(--primary);
        }

        header {
            border-bottom: 2px solid #eee;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 { 
            margin: 0 0 10px 0; 
            font-size: 1.8rem; 
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .timer-badge {
            background: #edf2f7;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: bold;
            display: inline-block;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: #eee;
            margin-top: 15px;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #e67e22);
            width: 0%;
            transition: width 0.4s ease;
        }

        .controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1.5rem;
        }

        .toggle-btn {
            background: none;
            border: 1px solid var(--primary-light);
            color: var(--primary-light);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .toggle-btn:hover { background: #f0f4f8; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
            width: 100%;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .btn:hover:not(:disabled) { opacity: 0.95; transform: translateY(-1px); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: #718096;
        }
        
        .btn-outline { 
            background: white; 
            border: 2px solid var(--primary); 
            color: var(--primary); 
        }
        .btn-outline:hover { background: #f8f9fa; }

        .btn-skip {
            background: transparent;
            border: 1px solid #bdc3c7;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .btn-skip:hover {
            border-color: var(--text);
            color: var(--text);
            background: #fdfdfd;
        }

        .card {
            background: #fbfbfc;
            border: 1px solid #eef0f2;
            border-left: 5px solid var(--accent);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0 8px 8px 0;
            box-shadow: var(--shadow-sm);
        }

        .bible-text {
            font-family: var(--font-serif);
            font-style: italic;
            background: #fffdf5;
            color: #444;
            padding: 1.2rem;
            border: 1px solid #e8e0c5;
            border-radius: 6px;
            margin-bottom: 1rem;
            line-height: 1.7;
            position: relative;
        }
        .bible-text::before {
            content: "‚ùû";
            position: absolute;
            top: -10px;
            right: 10px;
            font-size: 3rem;
            color: rgba(0,0,0,0.05);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        @media(min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        .option-btn {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 16px;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }
        .option-btn:hover { border-color: var(--primary); transform: translateY(-2px); }
        .option-btn.selected { border-color: var(--primary); background: #ebf5fb; }
        .option-btn.correct { border-color: var(--success); background: #eafaf1; }
        .option-btn.wrong { border-color: var(--error); background: #fdedec; }
        .option-btn:disabled { opacity: 0.7; cursor: default; transform: none; }

        textarea, input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            margin-top: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        #feedback-area {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 500;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .feedback-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; }
        .feedback-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; }
        .feedback-info { background: #e8f4fd; color: #0c5460; border-left: 4px solid #17a2b8; padding: 10px 15px; margin-bottom: 15px; }

        .sort-zone {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
        }
        .sort-btn {
            flex: 1;
            padding: 25px;
            border: 2px dashed #bdc3c7;
            background: #fafafa;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            border-radius: 8px;
            color: #7f8c8d;
            transition: all 0.2s;
        }
        .sort-btn:hover { background: #fff; border-color: var(--primary); color: var(--primary); }

        #final-report {
            border: 1px solid #ddd;
            padding: 30px;
            background: white;
            color: #333;
            font-size: 0.95rem;
            box-shadow: var(--shadow-sm);
        }
        .report-section { margin-bottom: 25px; }
        .report-section h4 {
            margin: 0 0 8px 0;
            color: var(--accent);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
            display: inline-block;
        }
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        @media(max-width: 700px) { .report-grid { grid-template-columns: 1fr; } }
        
        .text-status {
            font-size: 0.85rem;
            text-align: right;
            margin-top: 8px;
            font-weight: 600;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
        }

        .instruction-box {
            background-color: #f0f7ff;
            border: 2px dashed #0056b3;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        .instruction-box h4 {
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .instruction-box ol {
            margin: 0;
            padding-left: 20px;
            color: #444;
        }
        .instruction-box li {
            margin-bottom: 5px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        #modal-message {
            white-space: pre-line;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .hidden { display: none !important; }
        
        .privacy-note {
            font-size: 0.8rem;
            color: #666;
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            text-align: center;
            font-family: var(--font-main);
        }

        *:focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body>

<div id="app">
    <header id="main-header">
        <div class="header-left" style="flex:1;">
            <h1>Textdetektiv: Gott oder Satan?</h1>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>
        <div class="header-right">
            <span class="timer-badge" id="timer-display">00:00</span>
        </div>
    </header>

    <div class="controls" id="top-controls">
        <button id="hint-toggle" class="toggle-btn" onclick="toggleHints()" aria-pressed="false">Hilfen: AUS</button>
    </div>

    <!-- MAIN CONTENT CONTAINER -->
    <main id="game-content" aria-live="polite">
        <!-- Content gets injected here via JS -->
    </main>

    <!-- FOOTER -->
    <footer id="game-footer" style="margin-top: 3rem; border-top: 1px solid #eee; padding-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap:10px;">
        <button class="btn btn-skip" style="font-size:0.8rem; padding: 8px 16px;" onclick="confirmReset()">Neustart / Daten l√∂schen</button>
        <span style="font-size: 0.85rem; color: #95a5a6;">Didaktisches Niveau: Oberstufe (Advanced)</span>
    </footer>
</div>

<!-- Custom Modal Structure -->
<div id="custom-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 id="modal-title" style="margin-top:0;">Best√§tigung</h3>
        <p id="modal-message">Bist du sicher?</p>
        <div class="modal-buttons">
            <button class="btn btn-outline" onclick="closeModal()">Abbrechen</button>
            <button class="btn" id="modal-confirm-btn">Best√§tigen</button>
        </div>
    </div>
</div>

<script>
    /* --- STATE MANAGEMENT --- */
    const state = {
        currentStep: 0,
        hintsEnabled: false,
        userName: '',
        timerSeconds: 0,
        timerRunning: false,
        mistakes: [], 
        skippedMissions: [], 
        answers: {
            mission1: null,
            mission2: null,
            mission4_reflexion: '',
            final_verdict: '',
            final_text: ''
        },
        mission3Items: [
            { id: 1, text: "Problem des Monismus: Gott tr√§gt das Dunkle und Unverst√§ndliche in sich selbst.", target: 'A' },
            { id: 2, text: "Gefahr des Dualismus: Etablierung einer b√∂sen Gegenmacht fast auf Augenh√∂he Gottes.", target: 'B' },
            { id: 3, text: "Moralische Eindeutigkeit: Gott ist ausschlie√ülich gut (summum bonum), das B√∂se ist 'drau√üen'.", target: 'B' },
            { id: 4, text: "Verlust der 'harmlosen' Unschuld Gottes: Er ist souver√§n, aber gef√§hrlich.", target: 'A' }
        ],
        mission3Index: 0
    };

    let timerInterval = null;

    /* --- DOM ELEMENTS --- */
    const content = document.getElementById('game-content');
    const progressBar = document.getElementById('progress-bar');
    const hintBtn = document.getElementById('hint-toggle');
    const timerDisplay = document.getElementById('timer-display');
    const topControls = document.getElementById('top-controls');
    
    // Modal Elements
    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');

    /* --- INIT --- */
    window.onload = () => {
        loadData();
        render();
        if(state.currentStep > 0 && state.currentStep < 6) {
            startTimer();
        }
    };

    /* --- CUSTOM MODAL LOGIC (SECURITY HARDENED) --- */
    function showModal(title, message, onConfirmCallback) {
        modalTitle.textContent = title;
        // SECURITY: Nutzung von textContent statt innerHTML zur XSS-Vermeidung
        modalMessage.textContent = message; 
        modalConfirmBtn.onclick = function() {
            onConfirmCallback();
            closeModal();
        };
        modal.classList.remove('hidden');
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    function showAlert(message) {
        showModal("Hinweis", message, () => {});
        modalConfirmBtn.textContent = "OK";
        const cancelBtn = modal.querySelector('.btn-outline');
        if(cancelBtn) cancelBtn.style.display = 'none';
        
        const originalOnClick = modalConfirmBtn.onclick;
        modalConfirmBtn.onclick = () => {
            closeModal();
            setTimeout(() => {
                modalConfirmBtn.textContent = "Best√§tigen";
                if(cancelBtn) cancelBtn.style.display = 'inline-block';
            }, 300);
        };
    }

    /* --- TIMER --- */
    function startTimer() {
        if(state.timerRunning) return;
        state.timerRunning = true;
        timerInterval = setInterval(() => {
            state.timerSeconds++;
            updateTimerDisplay();
            if(state.timerSeconds % 30 === 0) saveData(); 
        }, 1000);
    }

    function stopTimer() {
        state.timerRunning = false;
        clearInterval(timerInterval);
        saveData();
    }

    function updateTimerDisplay() {
        const mins = Math.floor(state.timerSeconds / 60);
        const secs = state.timerSeconds % 60;
        timerDisplay.textContent = 
            (mins < 10 ? "0" + mins : mins) + ":" + 
            (secs < 10 ? "0" + secs : secs);
    }

    /* --- CORE RENDERING --- */
    function render() {
        updateUI();
        content.innerHTML = ''; 

        switch(state.currentStep) {
            case 0: renderStart(); break;
            case 1: renderMission1(); break;
            case 2: renderMission2(); break;
            case 3: renderMission3(); break;
            case 4: renderMission4(); break;
            case 5: renderFinal(); break;
            case 6: renderResult(); break;
        }
    }

    function updateUI() {
        updateTimerDisplay();
        const totalSteps = 6;
        const pct = (state.currentStep / totalSteps) * 100;
        progressBar.style.width = pct + '%';
        hintBtn.textContent = state.hintsEnabled ? "Hilfen: AN" : "Hilfen: AUS";
        hintBtn.classList.toggle('active', state.hintsEnabled);
        hintBtn.setAttribute('aria-pressed', state.hintsEnabled);
        
        if (state.currentStep === 0) {
            topControls.classList.add('hidden');
            document.getElementById('main-header').style.display = 'flex'; 
        } else if (state.currentStep < 6) {
            topControls.classList.remove('hidden');
            document.getElementById('main-header').style.display = 'flex';
        } else {
            document.getElementById('main-header').style.display = 'none';
            topControls.classList.add('hidden');
        }
    }

    function nextStep() {
        state.currentStep++;
        saveData();
        render();
    }

    function triggerSkip(missionName) {
        showModal(
            "Aufgabe √ºberspringen?", 
            "M√∂chtest du diese Aufgabe wirklich √ºberspringen?\n(Dies wird im Protokoll als 'nicht bearbeitet' vermerkt.)", 
            () => executeSkip(missionName)
        );
    }

    function executeSkip(missionName) {
        state.skippedMissions = state.skippedMissions || [];
        state.skippedMissions.push(missionName);
        
        if (missionName === "Mission 1") state.answers.mission1 = "--- (√úbersprungen)";
        if (missionName === "Mission 2") state.answers.mission2 = "--- (√úbersprungen)";
        if (missionName === "Mission 4") state.answers.mission4_reflexion = "(Aufgabe wurde √ºbersprungen)";
        
        if (missionName === "Mission 3") {
            state.mission3Index = state.mission3Items.length; 
        }

        nextStep();
    }

    /* --- FEEDBACK HELPER (SECURITY) --- */
    // SECURITY: Trennt Struktur von Inhalt. Nutzt innerHTML nur f√ºr statische Formatierung, keine Inputs.
    function setFeedback(targetId, type, htmlContent) {
        const area = document.getElementById(targetId);
        if (!area) return;
        area.innerHTML = '';
        const div = document.createElement('div');
        div.className = type === 'success' ? 'feedback-success' : 'feedback-error';
        // HINWEIS: Hier wird innerHTML f√ºr statische Strings aus dem Code verwendet (z.B. bold tags).
        // Es flie√üen an keiner Stelle User-Inputs in diesen Parameter.
        div.innerHTML = htmlContent; 
        area.appendChild(div);
    }

    function pushMistake(code) {
        state.mistakes.push(code);
        // DSGVO/Robustheit: Begrenzung auf 50 Eintr√§ge
        if (state.mistakes.length > 50) {
            state.mistakes.shift();
        }
    }

    /* --- SCREENS --- */

    function renderStart() {
        content.innerHTML = `
            <h2>Willkommen im Archiv</h2>
            <p style="font-size:1.1rem;">Du untersuchst einen theologischen Pr√§zedenzfall der Bibel. Zwei Texte erz√§hlen dasselbe Ereignis, widersprechen sich aber in der Ursache des B√∂sen fundamental.</p>
            <div class="card">
                <h3>Deine Mission (Profi-Modus)</h3>
                <ul style="padding-left:20px;">
                    <li style="margin-bottom:8px;">Vergleiche die Quellen pr√§zise (2 Sam vs. 1 Chr).</li>
                    <li style="margin-bottom:8px;">Analysiere die redaktionsgeschichtliche Motivation.</li>
                    <li>F√§lle ein Urteil im Spannungsfeld von Monotheismus und Theodizee.</li>
                </ul>
                <p style="margin-top:15px; color:#666; font-size:0.9rem;"><em>Hinweis: Die Zeit l√§uft, sobald du startest! Falsche Entscheidungen werden am Ende dokumentiert.</em></p>
            </div>
            
            <div style="background:#f0f4f8; padding:20px; border-radius:8px; margin-top:20px;">
                <label for="username" style="display:block; margin-bottom:5px; font-weight:bold;">Name / Team (optional):</label>
                <!-- SECURITY: Username nicht in Template interpoliert -->
                <input type="text" id="username" placeholder="Dein Name/Pseudonym..." maxlength="40" style="max-width:300px;">
                <br>
                <button class="btn" style="margin-top:10px;" onclick="startGame()">Untersuchung starten</button>
            </div>

            <!-- DSGVO Info Box -->
            <div class="privacy-note">
                Speicherung ausschlie√ülich lokal auf diesem Ger√§t; keine √úbertragung; jederzeit l√∂schbar.
            </div>
        `;

        // SECURITY: Sicherer Wert-Transfer via DOM
        const input = document.getElementById('username');
        if(input) input.value = state.userName || '';
    }

    function startGame() {
        const input = document.getElementById('username');
        // DSGVO: Name ist optional
        const nameVal = input.value.trim();
        state.userName = nameVal === "" ? "Anonym" : nameVal.slice(0, 40);
        startTimer();
        nextStep();
    }

    // --- MISSION 1 ---
    function renderMission1() {
        const hintHtml = state.hintsEnabled ? `<div class="feedback-info"><small>üí° Tipp: Achte auf das grammatikalische Subjekt des Verbs 'reizen/aufstehen'. Wer ist der Agens?</small></div>` : '';
        
        content.innerHTML = `
            <h3>Mission 1: Analyse der Kausalit√§t</h3>
            <p class="meta">Analysiere die beiden Textfassungen hinsichtlich der Urheberschaft des Unheils.</p>
            ${hintHtml}
            <div class="compare-container">
                <div>
                    <h4>2. Samuel 24,1 (√§ltere Quelle)</h4>
                    <div class="bible-text">
                        "Und der Zorn des HERRN entbrannte abermals gegen Israel, und <strong>ER</strong> reizte David gegen das Volk und sprach: Go, z√§hle Israel und Juda!" (sinngem√§√ü)
                    </div>
                </div>
                <div>
                    <h4>1. Chronik 21,1 (j√ºngere Quelle)</h4>
                    <div class="bible-text">
                        "Und <strong>SATAN</strong> stand auf gegen Israel und reizte David, dass er Israel z√§hlte." (sinngem√§√ü)
                    </div>
                </div>
            </div>
            
            <p><strong>Welche theologische Verschiebung findet hier statt?</strong></p>
            
            <div class="options-grid">
                <button class="option-btn" onclick="checkM1(this, false)">In beiden F√§llen ist David der alleinige Initiator, die Texte unterscheiden sich nur im literarischen Stil.</button>
                <button class="option-btn" onclick="checkM1(this, true)">Samuel: Gott selbst ist unmittelbarer Verursacher des Unheils. <br>Chronik: Eine antagonistische Zwischeninstanz wird eingef√ºhrt.</button>
                <button class="option-btn" onclick="checkM1(this, false)">Samuel: Ein namenloser D√§mon verf√ºhrt David. <br>Chronik: Gott greift korrigierend ein.</button>
                <button class="option-btn" onclick="checkM1(this, false)">Es gibt keinen Unterschied in der Kausalit√§t, 'Satan' ist im Hebr√§ischen hier nur ein anderes Wort f√ºr Gott.</button>
            </div>
            
            <div id="feedback-area"></div>
            
            <div class="btn-group">
                <button id="next-btn" class="btn hidden" onclick="nextStep()">Weiter zu Mission 2</button>
                <button id="skip-btn-m1" type="button" class="btn btn-skip" style="margin-left:auto;" onclick="triggerSkip('Mission 1')">Aufgabe √ºberspringen</button>
            </div>
        `;
    }

    function checkM1(btn, isCorrect) {
        const nextBtn = document.getElementById('next-btn');
        document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

        if (isCorrect) {
            btn.classList.add('correct');
            state.answers.mission1 = "Korrekt erkannt";
            setFeedback('feedback-area', 'success', 'Exakt. In der √§lteren Schicht (Samuel) ist der Monotheismus so streng, dass Gott auch das √úbel wirken muss ("ER reizte David"). Die Chronik schiebt Satan als "Entlastungsinstanz" dazwischen.');
            nextBtn.classList.remove('hidden');
            const skipBtn = document.getElementById('skip-btn-m1');
            if(skipBtn) skipBtn.style.display = 'none';
            nextBtn.focus();
        } else {
            btn.classList.add('wrong');
            pushMistake("M1: Kausalit√§t falsch");
            setFeedback('feedback-area', 'error', 'Unpr√§zise Analyse. Lies 2. Samuel 24,1 genau: "ER [der HERR] reizte David". Fehler wurde protokolliert. Versuche es erneut.');
            setTimeout(() => { document.querySelectorAll('.option-btn').forEach(b => b.disabled = false); btn.classList.remove('wrong'); }, 2000);
        }
        saveData();
    }

    // --- MISSION 2 ---
    function renderMission2() {
        const hintHtml = state.hintsEnabled ? `<div class="feedback-info"><small>üí° Tipp: Die Chronik entstand nach dem Exil. Das Gottesbild hatte sich gewandelt: Gott sollte rein und gerecht sein.</small></div>` : '';

        content.innerHTML = `
            <h3>Mission 2: Redaktionsgeschichtliche Einordnung</h3>
            <p class="meta">Die √Ñnderung in der Chronik ist kein Zufall. Welches theologische Motiv treibt die Redakteure?</p>
            ${hintHtml}
            
            <div class="options-grid">
                <button class="option-btn" onclick="checkM2(this, false)">A) Historische Korrektur: Den Chronisten lagen neuere arch√§ologische Beweise vor, dass tats√§chlich eine Person namens Satan David bestochen hatte.</button>
                <button class="option-btn" onclick="checkM2(this, true)">B) Theologische 'Reinigung': Ein Gottesbild, in dem Gott zur S√ºnde anstiftet, war nicht mehr plausibel. Gott sollte vom Ursprung des B√∂sen entlastet werden.</button>
                <button class="option-btn" onclick="checkM2(this, false)">C) Literarische Metaphorik: 'Satan' ist hier lediglich eine Umschreibung f√ºr Davids eigenes schlechtes Gewissen und innere Zerrissenheit.</button>
                <button class="option-btn" onclick="checkM2(this, false)">D) Polytheistische Anpassung: Die Chronisten wollten zu einem Glauben an zwei gleichstarke G√∂tter (Gut und B√∂se) zur√ºckkehren.</button>
            </div>
            
            <div id="feedback-area"></div>
            
            <div class="btn-group">
                <button id="next-btn" class="btn hidden" onclick="nextStep()">Weiter zu Mission 3</button>
                <button id="skip-btn-m2" type="button" class="btn btn-skip" style="margin-left:auto;" onclick="triggerSkip('Mission 2')">Aufgabe √ºberspringen</button>
            </div>
        `;
    }

    function checkM2(btn, isCorrect) {
        const nextBtn = document.getElementById('next-btn');
        document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

        if(isCorrect) {
            btn.classList.add('correct');
            setFeedback('feedback-area', 'success', 'Korrekt. Das Ziel ist die Entlastung Gottes (Theodizee-Problem). Wenn Gott absolut gut ist, darf er nicht Urheber der S√ºnde sein. Also braucht man einen S√ºndenbock: den Satan.');
            nextBtn.classList.remove('hidden');
            const skipBtn = document.getElementById('skip-btn-m2');
            if(skipBtn) skipBtn.style.display = 'none';
            nextBtn.focus();
        } else {
            btn.classList.add('wrong');
            pushMistake("M2: Motiv nicht erkannt");
            setFeedback('feedback-area', 'error', 'Falsch. Historische Beweise gab es nicht, und Satan ist im AT auch keine blo√üe psychologische Metapher. Fehler protokolliert.');
            setTimeout(() => { document.querySelectorAll('.option-btn').forEach(b => b.disabled = false); btn.classList.remove('wrong'); }, 2000);
        }
    }

    // --- MISSION 3 ---
    function renderMission3() {
        if(state.mission3Index >= state.mission3Items.length) {
            content.innerHTML = `
                <h3>Mission 3 abgeschlossen!</h3>
                <p>Du hast die dogmatischen Implikationen (Monismus vs. Dualismus) durchdrungen.</p>
                <div class="btn-group">
                    <button class="btn" onclick="nextStep()">Weiter zu Mission 4</button>
                </div>
            `;
            return;
        }

        const currentItem = state.mission3Items[state.mission3Index];
        const hintHtml = state.hintsEnabled ? `<div class="feedback-info"><small>üí° Tipp: Szenario A (Samuel) = Gott macht alles (auch Schweres). Szenario B (Chronik) = Gott ist 'sauber', aber Satan hat Macht.</small></div>` : '';

        content.innerHTML = `
            <h3>Mission 3: Der theologische Preis</h3>
            <p>Ordne die theologische Konsequenz (Dogmatik) dem richtigen Modell zu.</p>
            ${hintHtml}
            
            <div class="card" style="text-align:center; font-size: 1.15rem; font-weight:600; border-left-color: var(--primary); color: var(--primary);">
                "${currentItem.text}"
            </div>

            <p style="text-align:center; color:#666;">Zu welchem Modell geh√∂rt diese Implikation?</p>

            <div class="sort-zone">
                <button class="sort-btn" onclick="checkM3('A')">
                    <strong>Modell A (Samuel)</strong><br>
                    Strikter Monismus<br><span style="font-weight:normal; font-size:0.85rem;">Gott als Alleinwirksamkeit</span>
                </button>
                <button class="sort-btn" onclick="checkM3('B')">
                    <strong>Modell B (Chronik)</strong><br>
                    Ansatz zum Dualismus<br><span style="font-weight:normal; font-size:0.85rem;">Gott vs. Satan</span>
                </button>
            </div>
            
            <div id="feedback-area"></div>
            
            <div class="btn-group">
                <button class="btn btn-skip" style="margin-left:auto;" onclick="triggerSkip('Mission 3')">Gesamte Mission 3 √ºberspringen</button>
            </div>
        `;
    }

    function checkM3(selection) {
        const currentItem = state.mission3Items[state.mission3Index];
        
        if (selection === currentItem.target) {
            setFeedback('feedback-area', 'success', 'Richtig analysiert!');
            setTimeout(() => {
                state.mission3Index++;
                renderMission3();
            }, 800);
        } else {
            pushMistake(`M3: Zuordnung falsch (Item ${currentItem.id})`);
            setFeedback('feedback-area', 'error', 'Falsch. Die Zuordnung passt nicht zum theologischen Modell. Fehler protokolliert.');
        }
    }

    // --- MISSION 4 ---
    function renderMission4() {
        const hintHtml = state.hintsEnabled ? `<div class="feedback-info"><small>üí° Tipp: 'Kanon' bedeutet die feste Liste der heiligen Schriften. Warum hat man 'Peinliches' nicht einfach zensiert?</small></div>` : '';

        content.innerHTML = `
            <h3>Mission 4: Die Kanon-Frage</h3>
            <p>J√ºrgen Ebach betont: Die Bibel hat den "anst√∂√üigen" alten Text (Samuel) nicht gel√∂scht, obwohl der neue (Chronik) "angenehmer" war. Beide stehen im Kanon.</p>
            ${hintHtml}
            
            <div class="card">
                <strong>Was ist die hermeneutische Funktion dieses Nebeneinanders?</strong>
            </div>
            
            <div class="options-grid">
                <button class="option-btn" onclick="checkM4(this, false)">Damit sich jeder Gl√§ubige die Version aussuchen kann, die ihm pers√∂nlich besser gef√§llt (Beliebigkeit).</button>
                <button class="option-btn" onclick="checkM4(this, true)">Um die Frage nach dem Ursprung des B√∂sen als offene Spannung (Dialektik) zu erhalten, statt sie vorschnell harmonisierend aufzul√∂sen.</button>
                <button class="option-btn" onclick="checkM4(this, false)">Dies ist ein Redaktionsfehler. Die Kanonisierungsprozesse waren unkoordiniert.</button>
            </div>

            <div id="reflexion-part" class="hidden" style="margin-top:20px; border-top:2px solid #eee; padding-top:20px;">
                <h4 style="color:var(--primary);">Deine Reflexion</h4>
                <p>Was wiegt f√ºr dich schwerer: Die Gefahr, dass Gott "b√∂se Z√ºge" bekommt (Samuel) ‚Äì oder die Gefahr, dass wir die Verantwortung f√ºr das B√∂se an einen "Teufel" abschieben (Chronik)?</p>
                
                <!-- SECURITY: Input Begrenzung -->
                <textarea id="reflexion-text" rows="4" maxlength="2000" placeholder="Formuliere deine Gedanken differenziert..." oninput="checkInput(this, 'submit-m4', 1, 10, 'reflexion-status')"></textarea>
                
                <!-- Status Anzeige f√ºr Transparenz -->
                <div id="reflexion-status" class="text-status" style="color:#c0392b;">0 von 1 S√§tzen (mind. 10 Zeichen).</div>

                <div class="btn-group">
                    <button id="submit-m4" class="btn" disabled onclick="finishM4()">Eingabe speichern</button>
                </div>
            </div>
            
            <div id="feedback-area"></div>
            
            <div class="btn-group">
                 <button class="btn btn-skip" id="skip-btn-m4" style="margin-left:auto;" onclick="triggerSkip('Mission 4')">Aufgabe √ºberspringen</button>
            </div>
        `;
    }

    function checkM4(btn, isCorrect) {
        if(isCorrect) {
            btn.classList.add('correct');
            setFeedback('feedback-area', 'success', 'Richtig. Die Bibel mutet uns die Ambiguit√§t zu. Sie liefert kein einfaches System, sondern Gespr√§chsanl√§sse.');
            document.getElementById('reflexion-part').classList.remove('hidden');
            document.getElementById('skip-btn-m4').classList.add('hidden'); 
        } else {
            btn.classList.add('wrong');
            pushMistake("M4: Kanon-Funktion nicht erkannt");
            setFeedback('feedback-area', 'error', 'Zu simpel gedacht. Kanonisierung ist ein bewusster Prozess. Fehler protokolliert.');
        }
    }

    function finishM4() {
        const text = document.getElementById('reflexion-text').value;
        // SECURITY: Input K√ºrzung
        state.answers.mission4_reflexion = text.trim().slice(0, 2000);
        nextStep();
    }

    // --- FINALE ---
    function renderFinal() {
        content.innerHTML = `
            <h3>Finale: Das theologische Urteil</h3>
            <p>Du hast die Akten gepr√ºft. Beziehe nun begr√ºndet Position.</p>
            
            <div style="background:#f9f9f9; padding:20px; border-radius:8px; border:1px solid #eee;">
                <label for="verdict-select" style="font-weight:bold;">Welche Position h√§ltst du f√ºr intellektuell redlicher?</label>
                <select id="verdict-select" style="margin-bottom:20px;">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="A">Position A (Samuel): Radikaler Monotheismus - Gott auch im Dunklen aushalten.</option>
                    <option value="B">Position B (Chronik): Entlastung Gottes - Das B√∂se vom Guten trennen.</option>
                    <option value="Open">Position C (Ebach): Aushalten der Spannung (Koinzidenz der Gegens√§tze).</option>
                </select>

                <label for="verdict-text" style="font-weight:bold;">Begr√ºnde deine Wahl (mind. 3 S√§tze):</label>
                <!-- SECURITY: Input Begrenzung -->
                <textarea id="verdict-text" rows="6" maxlength="4000" placeholder="Meine Entscheidung basiert auf der √úberlegung, dass..." oninput="checkInput(this, 'submit-final', 3, 30, 'verdict-status')"></textarea>
                
                <!-- Status Anzeige f√ºr Transparenz -->
                <div id="verdict-status" class="text-status" style="color:#c0392b;">0 von 3 S√§tzen (mind. 30 Zeichen).</div>
            </div>

            <div class="btn-group">
                <button id="submit-final" class="btn" disabled onclick="submitFinal()">Urteil f√§llen & Spiel beenden</button>
            </div>
        `;
    }

    function submitFinal() {
        const sel = document.getElementById('verdict-select').value;
        const txt = document.getElementById('verdict-text').value;
        
        if(!sel) {
            showAlert("Bitte w√§hle oben eine Position (Dropdown) aus.");
            return;
        }
        
        state.answers.final_verdict = sel;
        // SECURITY: Input K√ºrzung
        state.answers.final_text = txt.trim().slice(0, 4000);
        stopTimer();
        nextStep();
    }

    // --- ERGEBNIS / AUSWERTUNG ---
    function renderResult() {
        // Fehler-Liste
        let mistakesList = "";
        if (state.mistakes.length === 0) {
            mistakesList = '<span style="color:var(--success)">‚úî Keine dokumentierten Fehler.</span>';
        } else {
            mistakesList = '<ul style="margin:0; padding-left:20px; color:var(--error); font-size:0.9rem;">' + 
                           state.mistakes.map(m => `<li>${escapeHtml(m)}</li>`).join('') + 
                           '</ul>';
        }

        // √úbersprungene Aufgaben Liste
        let skippedHtml = "";
        let skippedText = "Keine";
        if(state.skippedMissions && state.skippedMissions.length > 0) {
            skippedHtml = '<ul style="margin:0; padding-left:20px; color:var(--neutral); font-size:0.9rem;">' + 
                          state.skippedMissions.map(m => `<li>${escapeHtml(m)} √ºbersprungen</li>`).join('') + 
                          '</ul>';
            skippedText = state.skippedMissions.join(", ");
        } else {
            skippedHtml = '<span style="color:var(--success)">‚úî Alle Aufgaben bearbeitet.</span>';
        }

        // Export Text
        const exportText = `
TEXTDETEKTIV: GOTT ODER SATAN (Profi-Modus)
Ermittler: ${state.userName}
Zeit: ${document.getElementById('timer-display').textContent}

STATUS DER AUFGABEN:
√úbersprungen: ${skippedText}

FEHLERPROTOKOLL:
${state.mistakes.length === 0 ? "Keine Fehler" : state.mistakes.map(m => "- " + m).join('\n')}

-----------------------------
EIGENE REFLEXION (Kanon-Frage):
${state.answers.mission4_reflexion}

ABSCHLUSSURTEIL (Position ${state.answers.final_verdict}):
${state.answers.final_text}
        `.trim();

        // Render Report UI mit ANLEITUNGS-BOX
        content.innerHTML = `
            <div id="final-report">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #2c3e50; padding-bottom:15px; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0; font-size:1.6rem; color:#2c3e50;">Abschlussprotokoll</h2>
                        <span style="font-size:1.1rem; font-weight:bold; color:var(--accent);">Ermittler: ${escapeHtml(state.userName)}</span>
                    </div>
                    <div style="text-align:right; font-size:0.9rem; color:#666;">
                        Zeit: ${document.getElementById('timer-display').textContent}
                    </div>
                </div>

                <div class="report-grid">
                    <div class="report-section">
                        <h4>Fehleranalyse</h4>
                        ${mistakesList}
                    </div>
                    <div class="report-section">
                        <h4>Bearbeitungsstatus</h4>
                        ${skippedHtml}
                    </div>
                </div>

                <div class="report-section">
                    <h4>Korrekte L√∂sungen (Idealweg)</h4>
                    <div style="font-size:0.85rem; line-height:1.5; background:#f0f4f8; padding:12px; border-radius:6px; color:#333;">
                        <strong>M1:</strong> 2 Sam = Gott (Monismus) / 1 Chr = Satan (Dualismus).<br>
                        <strong>M2:</strong> Motiv: Entlastung Gottes (Theodizee).<br>
                        <strong>M3:</strong> Preis: Gott wird dunkel (Samuel) vs. Gott wird machtlos (Chronik).<br>
                        <strong>M4:</strong> Kanon bewahrt Spannung statt Zensur.
                    </div>
                </div>

                <div class="report-section">
                    <h4>Eigene Reflexion</h4>
                    <div class="report-text-block">${escapeHtml(state.answers.mission4_reflexion)}</div>
                </div>

                <div class="report-section">
                    <h4>Eigenes Urteil (Position ${state.answers.final_verdict})</h4>
                    <div class="report-text-block">${escapeHtml(state.answers.final_text)}</div>
                </div>
                
                <div style="text-align:center; margin-top:20px; color:#aaa; font-size:0.8rem; border-top:1px solid #eee; padding-top:10px;">
                    [Automatisch generiertes Protokoll]
                </div>
            </div>

            <!-- TEAMS ANLEITUNG HIER EINGEF√úGT -->
            <div class="instruction-box">
                <h4>üì§ Anleitung zum Hochladen in Teams (iPad)</h4>
                <ol>
                    <li>Tippe unten auf "Protokoll herunterladen" und speichere die Datei in "Dateien" (Auf meinem iPad).</li>
                    <li>√ñffne die <strong>Teams-App</strong> und navigiere zu deiner Aufgabe.</li>
                    <li>Tippe auf <strong>"Arbeit hinzuf√ºgen"</strong> > <strong>"Von diesem Ger√§t hochladen"</strong>.</li>
                    <li>W√§hle die eben gespeicherte .txt-Datei aus.</li>
                    <li>Tippe oben rechts auf <strong>"Abgeben"</strong>.</li>
                </ol>
            </div>
            
            <div style="text-align:center; margin-top:30px;">
                <button class="btn" style="background:var(--success);" onclick="downloadTxt()">üì• Protokoll herunterladen (.txt)</button>
            </div>
            
            <!-- BUGFIX: Leeres Textarea, Wert wird per JS gesetzt, um HTML-Escaping im Download zu vermeiden -->
            <textarea id="export-source" class="hidden"></textarea>
        `;

        // SECURITY: Setze Wert per DOM Property
        const exportEl = document.getElementById('export-source');
        if(exportEl) exportEl.value = exportText;
    }

    /* --- UTILS --- */
    
    // Check-Funktion f√ºr Buttons
    function checkInput(el, btnId, minSentences, minChars, statusId) {
        const text = el.value.trim();
        const sentences = text.match(/[^\.!\?]+[\.!\?]+/g);
        const count = sentences ? sentences.length : 0;
        const btn = document.getElementById(btnId);
        const status = document.getElementById(statusId);
        
        const hasLength = text.length >= minChars;
        const hasSentences = count >= minSentences;

        if(hasLength && hasSentences) {
            btn.disabled = false;
            status.innerHTML = `‚úî ${count} von ${minSentences} S√§tzen. Bereit!`;
            status.style.color = "var(--success)";
        } else {
            btn.disabled = true;
            status.innerHTML = `${count} von ${minSentences} S√§tzen (und mind. ${minChars} Zeichen).`;
            status.style.color = "var(--error)";
        }
    }

    function toggleHints() {
        state.hintsEnabled = !state.hintsEnabled;
        render(); 
    }
    
    // Neue reset funktion die modal nutzt
    function confirmReset() {
        showModal("Spiel neustarten?", "Alle Fortschritte gehen verloren.", () => {
            stopTimer();
            localStorage.removeItem('textDetective_data');
            location.reload();
        });
    }

    // SECURITY: Robustes Speichern
    function saveData() {
        try {
            localStorage.setItem('textDetective_data', JSON.stringify(state));
        } catch (e) {
            console.error("Save failed:", e);
            showAlert("Speichern nicht m√∂glich (Speicher voll oder blockiert). Bitte Text k√ºrzen oder 'Neustart / Daten l√∂schen' nutzen.");
        }
    }

    // ROBUSTHEIT: Garantierte Arrays
    function loadData() {
        const data = localStorage.getItem('textDetective_data');
        if(data) {
            try {
                const parsed = JSON.parse(data);
                Object.assign(state, parsed);
            } catch(e) {
                console.error("Daten korrupt, Reset.");
                localStorage.removeItem('textDetective_data');
            }
        }
        state.skippedMissions = Array.isArray(state.skippedMissions) ? state.skippedMissions : [];
        state.mistakes = Array.isArray(state.mistakes) ? state.mistakes : [];
    }

    function escapeHtml(text) {
        if(!text) return "<em>(Keine Eingabe)</em>";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function downloadTxt() {
        // SECURITY: Nutze value Eigenschaft statt innerHTML f√ºr sicheren Transfer
        const text = document.getElementById('export-source').value;
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', 'Textdetektiv_Protokoll.txt');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

</script>
</body>
</html>