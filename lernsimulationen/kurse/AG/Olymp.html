<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Lernspiel Olympische Götter - DSGVO konform & Gehärtet">
    
    <!-- SECURITY: CSP Configuration -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'nonce-S3cur3N0nc3V4lu3'; object-src 'none'; base-uri 'none'; connect-src 'none'; media-src 'none'; frame-src 'none'; form-action 'none'; frame-ancestors 'none';">
    
    <title>Die Olympischen Götter - Lernspiel (Secure)</title>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --bg-color: #f0f9ff;
            --text-color: #1e293b;
            --primary: #2563eb;
            --secondary: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --card-gradient: linear-gradient(145deg, #ffffff, #f8fafc);
            --card-gradient-hover: linear-gradient(145deg, #ffffff, #eff6ff);
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- COMPONENTS --- */

        /* Toast Notifications */
        #toast-container {
            position: fixed; bottom: 1rem; right: 1rem; z-index: 1000;
            display: flex; flex-direction: column; gap: 0.5rem;
            pointer-events: none;
        }
        .toast {
            background: #334155; color: white; padding: 0.75rem 1rem;
            border-radius: 0.5rem; box-shadow: var(--shadow-lg);
            font-size: 0.875rem; animation: fadeIn 0.3s ease-out;
            max-width: 20rem; pointer-events: auto; display: flex; align-items: center; gap: 0.5rem;
        }
        .toast.error { background: #b91c1c; }
        .toast.success { background: #15803d; }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); z-index: 100;
            display: none; align-items: center; justify-content: center; padding: 1rem;
            backdrop-filter: blur(4px);
        }
        .modal-backdrop.active { display: flex; }

        /* Confirm Modal */
        .confirm-card {
            background: white; padding: 2rem; border-radius: 1rem;
            max-width: 22rem; text-align: center; box-shadow: var(--shadow-lg);
            border: 1px solid #e2e8f0; animation: popIn 0.2s ease-out;
        }
        .confirm-actions {
            display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
            color: white; padding: 1rem; box-shadow: var(--shadow-lg);
            border-bottom: 4px solid var(--secondary); z-index: 50;
        }
        .header-content {
            max-width: 80rem; margin: 0 auto;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem;
        }
        .title-area h1 { margin: 0; font-size: 1.5rem; font-weight: 800; letter-spacing: -0.025em; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .title-area p { margin: 0.25rem 0 0; color: #bfdbfe; font-size: 0.875rem; font-weight: 500; }
        .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 0.5rem;
            font-size: 0.875rem; font-weight: 600;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; transition: all 0.2s;
            background-color: rgba(255,255,255,0.1); color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn:hover { background-color: rgba(255,255,255,0.2); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-danger { background-color: #dc2626; border-color: transparent; }
        .btn-danger:hover { background-color: #b91c1c; }
        
        .btn-success { background-color: #16a34a; border-color: transparent; }
        .btn-success:hover { background-color: #15803d; }
        
        .btn-light { background-color: white; color: #334155; border: 1px solid #cbd5e1; }
        .btn-light:hover { background-color: #f1f5f9; }

        .status-badge {
            background-color: rgba(15, 23, 42, 0.4); padding: 0.5rem 1rem;
            border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: baseline; gap: 0.5rem;
            backdrop-filter: blur(4px);
        }
        .score-val { color: var(--secondary); font-weight: bold; font-size: 1.25rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        .score-total { color: #e2e8f0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Main Content */
        main {
            max-width: 80rem; margin: 0 auto; padding: 2rem 1rem;
            width: 100%; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 2rem;
        }

        /* Olymp Area */
        .olymp-stage {
            background-color: #f8fafc; border: 4px solid white; border-radius: 1.5rem;
            overflow: hidden; box-shadow: var(--shadow-lg); position: relative;
            width: 100%; aspect-ratio: 16 / 9;
            transition: transform 0.3s;
        }
        .olymp-bg {
            position: absolute; inset: 0;
            background-image: url('background.jpg'), linear-gradient(to bottom, #bae6fd, #e0f2fe, #f0f9ff);
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        .olymp-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.15); pointer-events: none; }
        
        .olymp-title {
            position: absolute; top: 1.5rem; left: 1.5rem; z-index: 20;
            background: rgba(255,255,255,0.95); padding: 0.75rem 1.25rem; border-radius: 1rem;
            box-shadow: var(--shadow); font-weight: 800; color: #1e3a8a;
            display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;
            border: 1px solid #e2e8f0;
        }

        /* God Avatars */
        .god-avatar-container {
            position: absolute; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            width: 80px; pointer-events: none;
        }
        .god-circle {
            width: 56px; height: 56px; border-radius: 50%;
            border: 3px solid #cbd5e1; background: #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
            position: relative; overflow: hidden;
        }
        @media (min-width: 768px) {
            .god-circle { width: 72px; height: 72px; border-width: 4px; }
            .god-avatar-container { width: 100px; }
        }

        .god-locked .god-circle { opacity: 0.5; filter: grayscale(100%) contrast(0.8); }
        .god-locked .god-label { opacity: 0; transform: translateY(-5px); }
        
        .god-unlocked { pointer-events: auto; cursor: pointer; }
        .god-unlocked .god-circle { 
            opacity: 1; filter: none;
            box-shadow: 0 0 0 4px rgba(255,255,255,0.5), 0 10px 15px -3px rgba(0,0,0,0.2);
            animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .god-unlocked .god-label { opacity: 1; transform: translateY(0); }
        .god-unlocked:hover .god-circle { transform: scale(1.15); z-index: 50; }

        .god-label {
            margin-top: 0.5rem; font-size: 0.75rem; font-weight: 700;
            background: white; padding: 0.25rem 0.75rem; border-radius: 999px;
            white-space: nowrap; color: #0f172a; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s; border: 1px solid #e2e8f0;
        }

        /* Grid Area */
        .section-header { 
            border-left: 5px solid #2563eb; padding-left: 1rem; margin-bottom: 1.5rem; 
            display: flex; align-items: baseline; gap: 1rem;
        }
        .section-header h2 { margin: 0; font-size: 1.5rem; color: #1e293b; letter-spacing: -0.025em; }
        .section-header span { font-size: 0.9rem; color: #64748b; font-weight: 500; }
        
        .grid-container { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; 
        }
        @media (min-width: 640px) { .grid-container { grid-template-columns: repeat(3, 1fr); gap: 1.25rem; } }
        @media (min-width: 1024px) { .grid-container { grid-template-columns: repeat(5, 1fr); gap: 1.5rem; } }

        /* --- UPGRADED CARD DESIGN --- */
        .tile {
            aspect-ratio: 3/4; 
            background: var(--card-gradient); 
            border-radius: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0; 
            border-bottom: 5px solid #cbd5e1; /* 3D Look */
            position: relative; overflow: hidden; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Pattern Overlay */
        .tile::before {
            content: ''; position: absolute; inset: 0;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 12px 12px; opacity: 0.15; pointer-events: none;
        }

        /* Hover State */
        .tile:not(.tile-completed):hover { 
            transform: translateY(-8px); 
            border-bottom-color: #3b82f6; 
            background: var(--card-gradient-hover);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }
        .tile:active { transform: translateY(-4px); border-bottom-width: 2px; }

        /* Content Wrapper */
        .tile-content {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Completed State */
        .tile-completed { 
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border-color: #86efac; 
            border-bottom-color: #22c55e; 
            cursor: default;
        }
        .tile-completed:hover { transform: none; box-shadow: var(--shadow); }
        .tile-completed .icon-wrapper { color: #16a34a; background: #dcfce7; border-color: #86efac; }

        /* Icon Circle on Card */
        .icon-wrapper {
            width: 3.5rem; height: 3.5rem; 
            border-radius: 50%; 
            background: #eff6ff; 
            color: #3b82f6;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 1rem;
            border: 2px solid #bfdbfe;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .tile:hover .icon-wrapper { transform: scale(1.1); background: #dbeafe; }

        /* Typography */
        .tile-label { font-weight: 800; color: #334155; font-size: 1rem; letter-spacing: -0.025em; }
        .tile-progress-text { font-size: 0.75rem; color: #64748b; font-weight: 600; font-family: monospace; margin-top: 0.5rem; }

        /* Modern Progress Bar */
        .progress-bar-bg { 
            width: 70%; height: 6px; background: #e2e8f0; border-radius: 999px; 
            margin-top: 0.75rem; overflow: hidden; 
        }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.5s ease-out; }
        
        /* Modal & Rest */
        .modal-card {
            background: white; width: 100%; max-width: 32rem; border-radius: 1.5rem;
            overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            border: 1px solid #e2e8f0; transform: scale(0.95); transition: transform 0.2s;
        }
        .modal-backdrop.active .modal-card { transform: scale(1); }

        .modal-header { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            padding: 2rem 1.5rem 1.5rem; text-align: center; position: relative; 
            border-bottom: 1px solid #bfdbfe;
        }
        .modal-header h2 { color: #1e3a8a; letter-spacing: -0.025em; margin: 0; font-size: 1.5rem; }
        .modal-body { padding: 2rem; display: flex; flex-direction: column; align-items: center; }
        
        .option-btn {
            width: 100%; padding: 1rem; background: white; color: #334155;
            border: 2px solid #e2e8f0; border-radius: 0.75rem; font-weight: 600; font-size: 1rem;
            cursor: pointer; margin-bottom: 0.75rem; transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .option-btn:hover { background: #f8fafc; border-color: #94a3b8; transform: translateY(-2px); }
        .option-btn:active { transform: scale(0.98); }
        
        .option-btn.correct { background: #dcfce7; color: #166534; border-color: #22c55e; box-shadow: 0 0 0 2px #dcfce7; }
        .option-btn.wrong { background: #fee2e2; color: #991b1b; border-color: #ef4444; animation: shake 0.4s; }

        .close-btn {
            position: absolute; top: 1rem; right: 1rem; background: white;
            border: 1px solid #e2e8f0; color: #64748b; cursor: pointer; padding: 0.5rem;
            border-radius: 50%; box-shadow: var(--shadow-sm); transition: all 0.2s;
        }
        .close-btn:hover { background: #f1f5f9; color: #0f172a; transform: rotate(90deg); }

        /* Win Screen */
        .win-screen {
            position: fixed; inset: 0; background: rgba(30,58,138,0.95); z-index: 200; 
            display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(5px);
        }
        .win-card {
            background: white; padding: 3rem; border-radius: 1.5rem; max-width: 40rem; 
            text-align: center; border: 8px solid #fcd34d; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        /* Animations */
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* God Classes */
        .bg-yellow { background-color: #fefce8; border-color: #eab308; color: #854d0e; }
        .bg-purple { background-color: #faf5ff; border-color: #a855f7; color: #6b21a8; }
        .bg-blue { background-color: #eff6ff; border-color: #3b82f6; color: #1e40af; }
        .bg-green { background-color: #f0fdf4; border-color: #22c55e; color: #166534; }
        .bg-slate { background-color: #f8fafc; border-color: #64748b; color: #334155; }
        .bg-red { background-color: #fef2f2; border-color: #ef4444; color: #991b1b; }
        .bg-orange { background-color: #fff7ed; border-color: #f97316; color: #9a3412; }
        .bg-orange-dark { background-color: #fff7ed; border-color: #ea580c; color: #7c2d12; }
        .bg-cyan { background-color: #ecfeff; border-color: #06b6d4; color: #155e75; }
        .bg-emerald { background-color: #ecfdf5; border-color: #10b981; color: #065f46; }
        .bg-pink { background-color: #fdf2f8; border-color: #ec4899; color: #9d174d; }
        .bg-fuchsia { background-color: #fdf4ff; border-color: #d946ef; color: #86198f; }
        .bg-amber { background-color: #fffbeb; border-color: #f59e0b; color: #92400e; }
        .bg-gray { background-color: #f9fafb; border-color: #4b5563; color: #1f2937; }

        .icon-svg { width: 100%; height: 100%; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        
        /* Word Puzzle */
        .letter-tile {
            width: 44px; height: 44px; background: white; color: #1e40af;
            border: 1px solid #cbd5e1; border-bottom: 3px solid #94a3b8; border-radius: 0.5rem;
            font-weight: 700; font-size: 1.25rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.1s;
        }
        .letter-tile:hover { transform: translateY(-2px); border-bottom-color: #64748b; }
        .letter-tile:active { transform: translateY(0); border-bottom-width: 0px; margin-top: 3px; }
        .word-slot {
            width: 44px; height: 44px; border-bottom: 3px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; color: #1e3a8a; cursor: pointer;
            background: #f8fafc; border-radius: 0.25rem 0.25rem 0 0;
        }
        .word-slot:hover { background: #f1f5f9; border-bottom-color: #94a3b8; }
        
        /* Utils */
        .msg-box { margin-top: 1rem; font-weight: bold; min-height: 1.5rem; }
        .msg-success { color: #16a34a; }
        .msg-error { color: #dc2626; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="confirm-modal" class="modal-backdrop">
        <div class="confirm-card">
            <h3 style="margin:0 0 1rem 0; font-size:1.25rem; color:#1e293b;">Aktion bestätigen</h3>
            <p id="confirm-msg" style="color:#64748b; margin-bottom:2rem;">Bist du sicher?</p>
            <div class="confirm-actions">
                <button id="btn-confirm-yes" class="btn btn-danger">Ja, ausführen</button>
                <button id="btn-confirm-no" class="btn btn-light">Abbrechen</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display:none">

    <header>
        <div class="header-content">
            <div class="title-area">
                <h1>Die Olympischen Götter</h1>
                <p>Schul-Edition (Secure Mode)</p>
            </div>
            <div class="controls">
                <div class="status-badge">
                    <span id="score-display" class="score-val">0</span>
                    <span id="total-display" class="score-total">/ 14 KOMPLETT</span>
                </div>
                <button id="btn-save" class="btn">Speichern</button>
                <button id="btn-load" class="btn">Laden</button>
                <button id="btn-reset" class="btn btn-danger">Neustart</button>
            </div>
        </div>
    </header>

    <main>
        <section class="olymp-stage">
            <div class="olymp-bg"></div>
            <div class="olymp-overlay"></div>
            <div class="olymp-title">
                <div style="width:24px;height:24px;color:#eab308;margin-right:0.5rem;">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 21h18"/><path d="M5 21V7l8-4 8 4v14"/><path d="M10 9a3 3 0 0 1 3 3v5h-6v-5a3 3 0 0 1 3-3"/></svg>
                </div>
                Der Olymp
            </div>
            <div id="olympus-container" style="position: absolute; inset:0; z-index:10;"></div>
        </section>

        <section>
            <div class="section-header">
                <h2>Die Prüfungen</h2>
                <span>(Wissen • Symbole • Wörter)</span>
            </div>
            <div id="grid-container" class="grid-container"></div>
        </section>
    </main>

    <div id="modal-backdrop" class="modal-backdrop">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-title">Prüfung</h2>
                <div id="riddle-progress-display" style="margin-top:0.5rem; font-size:0.875rem; color:#64748b; font-weight:500;"></div>
                <button id="btn-close-modal" class="close-btn">
                    <div style="width:20px;height:20px;"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
                </button>
            </div>
            <div class="modal-body">
                <div style="width:4.5rem; height:4.5rem; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem; border:4px solid white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); color:#64748b;">
                    <div id="game-icon-container" style="width:2.5rem; height:2.5rem;"></div>
                </div>
                <p id="riddle-text" style="text-align:center; margin-bottom:2rem; font-size:1.125rem; color:#334155; line-height:1.6; font-family:serif; font-style:italic;"></p>
                <div id="game-container" style="width:100%; display:flex; flex-direction:column; align-items:center; gap:1rem;"></div>
                <div id="feedback-msg" class="msg-box" style="margin-top:1.5rem; min-height:1.5rem; font-weight:bold; text-align:center;"></div>
            </div>
        </div>
    </div>

    <div id="win-screen" class="win-screen">
        <div class="win-card">
            <h2 style="font-size:3rem; margin:0 0 1rem 0; color:#1e3a8a; font-weight:900;">Olymp komplett!</h2>
            <p style="font-size:1.25rem; color:#475569;">Hervorragend! Du hast alle Götter versammelt.</p>
            <div style="display:flex; justify-content:center; gap:1.5rem; margin:2rem 0; color:#f59e0b;">
               <div style="width:48px;height:48px;"><svg class="icon-svg" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
               <div style="width:48px;height:48px;"><svg class="icon-svg" viewBox="0 0 24 24"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path></svg></div>
               <div style="width:48px;height:48px;"><svg class="icon-svg" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
            </div>
            <div style="display:flex; flex-direction:column; gap:1rem; align-items:center;">
                <button id="btn-download-report" class="btn btn-success" style="font-size:1.1rem; padding:1rem 2rem; border-radius:99px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">Statistik herunterladen</button>
                <div style="display:flex; gap:1rem;">
                    <button id="btn-view-olymp" class="btn btn-light">Ansehen</button>
                    <button id="btn-new-game" class="btn">Neues Spiel</button>
                </div>
            </div>
        </div>
    </div>

    <script nonce="S3cur3N0nc3V4lu3">
        "use strict";

        // --- ICON SYSTEM ---
        const ICONS = {
            'zap': '<path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>',
            'crown': '<path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path>',
            'waves': '<path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path>',
            'wheat': '<path d="M2 22 16 8"/><path d="M3.4 12.7c.9-1.5 2.4-1.7 3.5-.6s.9 2.6-.6 3.5c-1.5.9-2.9 1-3.5.6s-.3-2 1.2-4.1z"/><path d="M7 8c1-1.5 2.5-1.7 3.5-.6s.9 2.6-.6 3.5c-1.5 1-2.9 1-3.5.6s-.3-2 .6-3.5z"/>',
            'shield': '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path>',
            'sword': '<polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line>',
            'sun': '<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path>',
            'hammer': '<path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"></path><path d="M17.64 15 22 10.64"></path>',
            'feather': '<path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line>',
            'moon': '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>',
            'heart': '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>',
            'wine': '<path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/>',
            'flame': '<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.1 1-2 2-3a3.5 3.5 0 0 0-1 4.8z"/>',
            'skull': '<circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/>',
            'help-circle': '<circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path>',
            'check': '<polyline points="20 6 9 17 4 12"></polyline>',
            'anchor': '<circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/>',
            'leaf': '<path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/>',
            'book': '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
            'pen-tool': '<path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/>',
            'flower': '<circle cx="12" cy="12" r="3"/><path d="M12 16.5A4.5 4.5 0 1 1 7.5 12 4.5 4.5 0 1 1 12 7.5a4.5 4.5 0 1 1 4.5 4.5 4.5 4.5 0 1 1-4.5 4.5"/>',
            'brain-circuit': '<path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>',
            'eye': '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>',
            'type': '<polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>',
            'snowflake': '<line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>',
            'wind': '<path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/>',
            'droplet': '<path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.74L12 6 8 9.26C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/>',
            'star': '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
            'smile': '<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>',
            'key': '<circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/>'
        };

        const GODS_DATA = [
            { id: 'zeus', name: 'Zeus', title: 'Göttervater', x: 50, y: 15, cssClass: 'bg-yellow', icon: 'zap', challenges: [{ type: 'quiz', question: "Wer ist meine Mutter, die mich vor Kronos versteckte?", options: ["Gaia", "Rhea", "Hera"], correct: "Rhea" }, { type: 'symbol', question: "Wähle das Symbol meiner Macht:", correctIcon: 'zap', wrongIcons: ['anchor', 'leaf'] }, { type: 'word', question: "Auf welcher Insel wuchs ich heimlich auf?", word: "KRETA" }] },
            { id: 'hera', name: 'Hera', title: 'Göttermutter', x: 40, y: 20, cssClass: 'bg-purple', icon: 'crown', challenges: [{ type: 'quiz', question: "Welches Tier ist mir heilig?", options: ["Adler", "Pfau", "Eule"], correct: "Pfau" }, { type: 'symbol', question: "Wähle mein Herrschaftszeichen:", correctIcon: 'crown', wrongIcons: ['sword', 'hammer'] }, { type: 'word', question: "Wen verfolgte ich aus Eifersucht?", word: "IO" }] },
            { id: 'poseidon', name: 'Poseidon', title: 'Meeresgott', x: 60, y: 20, cssClass: 'bg-blue', icon: 'waves', challenges: [{ type: 'quiz', question: "Welches Tier erschuf ich aus Meerschaum?", options: ["Delphin", "Pferd", "Löwe"], correct: "Pferd" }, { type: 'symbol', question: "Womit lasse ich die Erde beben?", correctIcon: 'anchor', wrongIcons: ['sun', 'key'] }, { type: 'word', question: "Wie heißt mein versunkenes Reich?", word: "ATLANTIS" }] },
            { id: 'demeter', name: 'Demeter', title: 'Fruchtbarkeit', x: 30, y: 30, cssClass: 'bg-green', icon: 'wheat', challenges: [{ type: 'quiz', question: "Wie heißt meine Tochter, die geraubt wurde?", options: ["Persephone", "Athene", "Artemis"], correct: "Persephone" }, { type: 'symbol', question: "Was lasse ich wachsen?", correctIcon: 'wheat', wrongIcons: ['flame', 'droplet'] }, { type: 'word', question: "Wo fanden meine Mysterien statt?", word: "ELEUSIS" }] },
            { id: 'athena', name: 'Athena', title: 'Weisheit', x: 70, y: 30, cssClass: 'bg-slate', icon: 'shield', challenges: [{ type: 'quiz', question: "Aus welchem Körperteil des Zeus entsprang ich?", options: ["Schenkel", "Kopf", "Herz"], correct: "Kopf" }, { type: 'symbol', question: "Wähle das Symbol der Verteidigung:", correctIcon: 'shield', wrongIcons: ['heart', 'wine'] }, { type: 'word', question: "Welchen Baum schenkte ich Athen?", word: "OLIVENBAUM" }] },
            { id: 'ares', name: 'Ares', title: 'Kriegsgott', x: 20, y: 45, cssClass: 'bg-red', icon: 'sword', challenges: [{ type: 'quiz', question: "Wer ist meine ständige Begleiterin?", options: ["Nike", "Eris", "Iris"], correct: "Eris" }, { type: 'symbol', question: "Wähle mein Werkzeug:", correctIcon: 'sword', wrongIcons: ['feather', 'book'] }, { type: 'word', question: "Welche Stadt verehrte mich besonders?", word: "SPARTA" }] },
            { id: 'apollo', name: 'Apollon', title: 'Licht & Musik', x: 80, y: 45, cssClass: 'bg-orange', icon: 'sun', challenges: [{ type: 'quiz', question: "Wen besiegte ich im Musikwettstreit?", options: ["Pan", "Zeus", "Hermes"], correct: "Pan" }, { type: 'symbol', question: "Ich bin der Gott des...", correctIcon: 'sun', wrongIcons: ['moon', 'waves'] }, { type: 'word', question: "Wo stand mein berühmtestes Orakel?", word: "DELPHI" }] },
            { id: 'hephaestus', name: 'Hephaistos', title: 'Schmiedegott', x: 15, y: 65, cssClass: 'bg-orange-dark', icon: 'hammer', challenges: [{ type: 'quiz', question: "Wen fing ich in einem unsichtbaren Netz?", options: ["Zeus & Hera", "Ares & Aphrodite", "Apollo & Artemis"], correct: "Ares & Aphrodite" }, { type: 'symbol', question: "Womit arbeite ich?", correctIcon: 'hammer', wrongIcons: ['flower', 'pen-tool'] }, { type: 'word', question: "Unter welchem Berg ist meine Werkstatt?", word: "AETNA" }] },
            { id: 'hermes', name: 'Hermes', title: 'Götterbote', x: 85, y: 65, cssClass: 'bg-cyan', icon: 'feather', challenges: [{ type: 'quiz', question: "Was stahl ich meinem Bruder Apollon?", options: ["Pferde", "Rinder", "Schafe"], correct: "Rinder" }, { type: 'symbol', question: "Was hilft mir beim Fliegen?", correctIcon: 'feather', wrongIcons: ['anchor', 'shield'] }, { type: 'word', question: "Wie heißt mein Stab?", word: "CADUCEUS" }] },
            { id: 'artemis', name: 'Artemis', title: 'Jagdgöttin', x: 25, y: 80, cssClass: 'bg-emerald', icon: 'moon', challenges: [{ type: 'quiz', question: "In was verwandelte ich den Jäger Aktaion?", options: ["Bär", "Wolf", "Hirsch"], correct: "Hirsch" }, { type: 'symbol', question: "Welcher Himmelskörper gehört zu mir?", correctIcon: 'moon', wrongIcons: ['sun', 'star'] }, { type: 'word', question: "Was ist meine liebste Beschäftigung?", word: "JAGD" }] },
            { id: 'aphrodite', name: 'Aphrodite', title: 'Liebesgöttin', x: 75, y: 80, cssClass: 'bg-pink', icon: 'heart', challenges: [{ type: 'quiz', question: "Wer überreichte mir den goldenen Apfel?", options: ["Paris", "Hector", "Achilles"], correct: "Paris" }, { type: 'symbol', question: "Wähle das Symbol der Liebe:", correctIcon: 'heart', wrongIcons: ['skull', 'zap'] }, { type: 'word', question: "Woraus wurde ich geboren?", word: "MEERSCHAUM" }] },
            { id: 'dionysus', name: 'Dionysos', title: 'Weingott', x: 38, y: 85, cssClass: 'bg-fuchsia', icon: 'wine', challenges: [{ type: 'quiz', question: "Welcher König verwandelte durch mich alles in Gold?", options: ["Minos", "Midas", "Oedipus"], correct: "Midas" }, { type: 'symbol', question: "Was schenkte ich den Menschen?", correctIcon: 'wine', wrongIcons: ['snowflake', 'waves'] }, { type: 'word', question: "Was entstand aus meinen Festen?", word: "THEATER" }] },
            { id: 'hestia', name: 'Hestia', title: 'Herdfeuer', x: 62, y: 85, cssClass: 'bg-amber', icon: 'flame', challenges: [{ type: 'quiz', question: "Was darf niemals im Tempel erlöschen?", options: ["Das Licht", "Das Feuer", "Die Hoffnung"], correct: "Das Feuer" }, { type: 'symbol', question: "Ich wärme das Haus mit...", correctIcon: 'flame', wrongIcons: ['snowflake', 'wind'] }, { type: 'word', question: "Ich bin der Mittelpunkt im...", word: "HEIM" }] },
            { id: 'hades', name: 'Hades', title: 'Unterwelt', x: 50, y: 85, cssClass: 'bg-gray', icon: 'skull', challenges: [{ type: 'quiz', question: "Wie heißt der Fluss des Vergessens?", options: ["Styx", "Lethe", "Acheron"], correct: "Lethe" }, { type: 'symbol', question: "Ein Symbol der Sterblichkeit:", correctIcon: 'skull', wrongIcons: ['heart', 'smile'] }, { type: 'word', question: "Wie heißt mein dreiköpfiger Hund?", word: "KERBEROS" }] }
        ];

        const GOD_IDS = GODS_DATA.map(g => g.id);
        const STORAGE_KEY = 'olymp_secure_progress';
        let godProgress = Object.create(null);
        let currentGod = null;
        let currentChallengeIndex = -1;
        let currentWordState = { target: "", guess: [], shuffled: [] };
        
        let gameStats = { correct: 0, wrong: 0, startTime: Date.now() };
        let isProcessing = false;

        function getIconSVG(name) {
            const path = ICONS[name] || '<circle cx="12" cy="12" r="10"></circle>';
            return `<svg class="icon-svg" viewBox="0 0 24 24">${path}</svg>`;
        }

        // --- DOM HELPER ---
        function el(tag, className, text) {
            const e = document.createElement(tag);
            if (className) e.className = className;
            if (text) e.textContent = text;
            return e;
        }

        function renderOlympus() {
            const container = document.getElementById('olympus-container');
            while (container.firstChild) container.removeChild(container.firstChild);
            
            GODS_DATA.forEach(god => {
                const solvedIndices = godProgress[god.id] || [];
                const isFullySolved = solvedIndices.length === 3;
                
                const wrapper = el('div', `god-avatar-container ${isFullySolved ? 'god-unlocked' : 'god-locked'}`);
                wrapper.style.left = god.x + '%';
                wrapper.style.top = god.y + '%';
                
                const circle = el('div', `god-circle ${isFullySolved ? god.cssClass : ''}`);
                
                const iconDiv = el('div');
                iconDiv.style.width = '24px'; iconDiv.style.height = '24px';
                iconDiv.style.color = isFullySolved ? 'currentColor' : '#64748b';
                iconDiv.innerHTML = getIconSVG(god.icon); 
                
                circle.appendChild(iconDiv);
                wrapper.appendChild(circle);
                
                const label = el('div', 'god-label', god.name);
                wrapper.appendChild(label);
                
                container.appendChild(wrapper);
            });
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            while (container.firstChild) container.removeChild(container.firstChild);

            GODS_DATA.forEach(god => {
                const solvedIndices = godProgress[god.id] || [];
                const progressCount = solvedIndices.length;
                const isFullySolved = progressCount === 3;
                
                const tile = el('div', isFullySolved ? "tile tile-completed" : "tile");
                const content = el('div', 'tile-content');

                if (isFullySolved) {
                    const iconWrapper = el('div', 'icon-wrapper');
                    iconWrapper.style.cssText = "background:#dcfce7; border-color:#86efac; color:#16a34a;";
                    const iconDiv = el('div');
                    iconDiv.style.cssText = "width:2rem; height:2rem;";
                    iconDiv.innerHTML = getIconSVG('check');
                    iconWrapper.appendChild(iconDiv);
                    content.appendChild(iconWrapper);
                    
                    const nameDiv = el('div', 'tile-label', god.name);
                    content.appendChild(nameDiv);
                } else {
                    tile.addEventListener('click', () => openModal(god));
                    
                    const bg = el('div', 'tile-bg-pattern');
                    tile.appendChild(bg);
                    
                    const iconWrapper = el('div', 'icon-wrapper');
                    const iconDiv = el('div');
                    iconDiv.style.cssText = "width:2rem; height:2rem;";
                    iconDiv.innerHTML = getIconSVG('help-circle');
                    iconWrapper.appendChild(iconDiv);
                    content.appendChild(iconWrapper);
                    
                    const label = el('span', 'tile-label', 'Aufgaben');
                    content.appendChild(label);
                    
                    const progressBg = el('div', 'progress-bar-bg');
                    const progressFill = el('div', 'progress-bar-fill');
                    progressFill.style.width = (progressCount / 3 * 100) + '%';
                    progressBg.appendChild(progressFill);
                    content.appendChild(progressBg);
                    
                    const progressText = el('span', 'tile-progress-text', `${progressCount} / 3`);
                    content.appendChild(progressText);
                }
                tile.appendChild(content);
                container.appendChild(tile);
            });
        }

        function renderGame() {
            renderOlympus();
            renderGrid();
            updateScore();
            
            const allComplete = GODS_DATA.every(god => (godProgress[god.id] || []).length === 3);
            if (allComplete) {
                setTimeout(() => document.getElementById('win-screen').style.display = 'flex', 800);
            }
        }

        function updateScore() {
            let completedCount = 0;
            GODS_DATA.forEach(god => {
                if ((godProgress[god.id] || []).length === 3) completedCount++;
            });
            document.getElementById('score-display').textContent = completedCount;
        }

        function openModal(god) {
            if (isProcessing) return;
            currentGod = god;
            const solvedIndices = godProgress[god.id] || [];
            const available = [0, 1, 2].filter(i => !solvedIndices.includes(i));
            if (available.length === 0) return;
            
            currentChallengeIndex = available[0];
            const challenge = god.challenges[currentChallengeIndex];
            
            document.getElementById('feedback-msg').textContent = '';
            document.getElementById('feedback-msg').className = 'msg-box';
            document.getElementById('riddle-progress-display').textContent = `Aufgabe ${3 - available.length + 1} von 3`;
            document.getElementById('riddle-text').textContent = challenge.question;
            
            const container = document.getElementById('game-container');
            while (container.firstChild) container.removeChild(container.firstChild);
            
            const iconContainer = document.getElementById('game-icon-container');
            const titleEl = document.getElementById('modal-title');
            
            let typeIcon = 'brain-circuit';
            if (challenge.type === 'quiz') {
                titleEl.textContent = "Wissens-Duell";
                renderQuiz(challenge, container);
            } else if (challenge.type === 'symbol') {
                titleEl.textContent = "Symbol-Jagd";
                typeIcon = 'eye';
                renderSymbolGame(challenge, container);
            } else if (challenge.type === 'word') {
                titleEl.textContent = "Wort-Orakel";
                typeIcon = 'type';
                renderWordGame(challenge, container);
            }
            iconContainer.innerHTML = getIconSVG(typeIcon);
            
            const backdrop = document.getElementById('modal-backdrop');
            backdrop.style.display = 'flex';
            void backdrop.offsetWidth;
            backdrop.classList.add('active');
        }

        function closeModal() {
            const backdrop = document.getElementById('modal-backdrop');
            backdrop.classList.remove('active');
            setTimeout(() => {
                if(!backdrop.classList.contains('active')) {
                    backdrop.style.display = 'none';
                    currentGod = null;
                    isProcessing = false;
                }
            }, 300);
        }

        function handleAnswer(isCorrect, btnElement, question, givenAnswer) {
            if (isProcessing) return;
            isProcessing = true; 
            
            if (isCorrect) gameStats.correct++; else gameStats.wrong++;

            const feedback = document.getElementById('feedback-msg');
            
            if (isCorrect) {
                if(btnElement) btnElement.classList.add('correct');
                feedback.textContent = "Richtig!";
                feedback.className = "msg-box msg-success";
                
                if (!godProgress[currentGod.id]) godProgress[currentGod.id] = [];
                if (!godProgress[currentGod.id].includes(currentChallengeIndex)) {
                    godProgress[currentGod.id].push(currentChallengeIndex);
                }
                saveToLocalStorage();
                
                setTimeout(() => {
                    renderGame();
                    closeModal();
                }, 1200);
            } else {
                if(btnElement) {
                    btnElement.classList.add('wrong');
                    setTimeout(() => btnElement.classList.remove('wrong'), 500);
                }
                feedback.textContent = "Leider falsch.";
                feedback.className = "msg-box msg-error";
                isProcessing = false; 
            }
        }

        function renderQuiz(challenge, container) {
            challenge.options.forEach(opt => {
                const btn = el('button', 'option-btn', opt);
                btn.addEventListener('click', (e) => handleAnswer(opt === challenge.correct, e.target, challenge.question, opt));
                container.appendChild(btn);
            });
        }

        function renderSymbolGame(challenge, container) {
            const wrapper = el('div');
            wrapper.style.cssText = "display:flex; gap:1.5rem; margin-top:0.5rem;";
            
            let icons = [challenge.correctIcon, ...challenge.wrongIcons].sort(() => Math.random() - 0.5);
            icons.forEach(iconName => {
                const btn = el('button', 'btn');
                btn.style.cssText = "width:5rem; height:5rem; background:#f1f5f9; border-color:#cbd5e1; color:#475569;";
                const ico = el('div');
                ico.style.cssText = "width:2.5rem; height:2.5rem;";
                ico.innerHTML = getIconSVG(iconName);
                btn.appendChild(ico);
                btn.addEventListener('click', (e) => handleAnswer(iconName === challenge.correctIcon, btn.closest('button'), challenge.question, "Icon: " + iconName));
                wrapper.appendChild(btn);
            });
            container.appendChild(wrapper);
        }

        function renderWordGame(challenge, container) {
            currentWordState.target = challenge.word;
            currentWordState.guess = [];
            currentWordState.shuffled = challenge.word.split('').sort(() => Math.random() - 0.5);

            const guessArea = el('div');
            guessArea.id = "word-guess-area";
            guessArea.style.cssText = "display:flex; gap:0.5rem; min-height:3rem;";
            
            const poolArea = el('div');
            poolArea.id = "word-pool-area";
            poolArea.style.cssText = "display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:center;";

            container.appendChild(guessArea);
            container.appendChild(poolArea);
            updateWordUI();
        }

        function updateWordUI() {
            const guessArea = document.getElementById('word-guess-area');
            const poolArea = document.getElementById('word-pool-area');
            while (guessArea.firstChild) guessArea.removeChild(guessArea.firstChild);
            while (poolArea.firstChild) poolArea.removeChild(poolArea.firstChild);

            for (let i = 0; i < currentWordState.target.length; i++) {
                const letter = currentWordState.guess[i] || "_";
                const slot = el('div', 'word-slot', letter);
                slot.addEventListener('click', () => {
                    if (currentWordState.guess.length > 0 && !isProcessing) {
                        const removed = currentWordState.guess.pop();
                        currentWordState.shuffled.push(removed);
                        updateWordUI();
                    }
                });
                guessArea.appendChild(slot);
            }

            currentWordState.shuffled.forEach((char, idx) => {
                const btn = el('button', 'letter-tile', char);
                btn.addEventListener('click', () => {
                    if (currentWordState.guess.length < currentWordState.target.length && !isProcessing) {
                        currentWordState.guess.push(char);
                        currentWordState.shuffled.splice(idx, 1);
                        updateWordUI();
                        checkWordWin();
                    }
                });
                poolArea.appendChild(btn);
            });
        }

        function checkWordWin() {
            const guessStr = currentWordState.guess.join('');
            if (guessStr.length === currentWordState.target.length) {
                const isCorrect = guessStr === currentWordState.target;
                const guessArea = document.getElementById('word-guess-area');
                
                if (isCorrect) {
                    guessArea.style.color = '#16a34a';
                    handleAnswer(true, null, "Wort", guessStr);
                } else {
                    handleAnswer(false, null, "Wort", guessStr);
                    guessArea.style.transform = 'translateX(-5px)';
                    guessArea.style.color = '#dc2626';
                    setTimeout(() => {
                        guessArea.style.transform = 'translateX(5px)';
                        setTimeout(() => {
                            guessArea.style.transform = 'none';
                            currentWordState.shuffled.push(...currentWordState.guess);
                            currentWordState.guess = [];
                            guessArea.style.color = 'inherit';
                            updateWordUI();
                            document.getElementById('feedback-msg').textContent = '';
                        }, 100);
                    }, 100);
                }
            }
        }

        // --- IO & CONFIRMS ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = el('div', `toast ${type}`, msg);
            const icon = el('div');
            icon.style.cssText = "width:1.25rem; height:1.25rem;";
            icon.innerHTML = type === 'success' ? getIconSVG('check') : getIconSVG('help-circle');
            toast.prepend(icon);
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function confirmAction(msg, onYes) {
            const modal = document.getElementById('confirm-modal');
            const msgEl = document.getElementById('confirm-msg');
            const btnYes = document.getElementById('btn-confirm-yes');
            const btnNo = document.getElementById('btn-confirm-no');
            
            msgEl.textContent = msg;
            modal.style.display = 'flex';
            
            const close = () => { modal.style.display = 'none'; btnYes.onclick = null; btnNo.onclick = null; };
            btnYes.onclick = () => { close(); onYes(); };
            btnNo.onclick = close;
        }

        function saveToLocalStorage() {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(godProgress)); } catch(e){}
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    const safe = Object.create(null);
                    GOD_IDS.forEach(id => {
                        if(Array.isArray(parsed[id])) {
                            const unique = [...new Set(parsed[id].filter(n => Number.isInteger(n) && n>=0 && n<=2))];
                            safe[id] = unique.slice(0,3);
                        }
                    });
                    godProgress = safe;
                } catch(e){}
            }
        }

        function downloadSave() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(godProgress));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "olymp-experte.json");
            document.body.appendChild(dlAnchor);
            dlAnchor.click();
            document.body.removeChild(dlAnchor);
        }

        function triggerUpload() { document.getElementById('fileInput').click(); }

        function uploadSave(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 10240) { showToast('Datei zu groß', 'error'); return; }

            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const raw = ev.target.result;
                    if (raw.includes("__proto__") || raw.includes("constructor") || raw.includes("prototype")) {
                        throw new Error("Invalid keys");
                    }
                    const data = JSON.parse(raw);
                    
                    const safeData = Object.create(null);
                    let count = 0;
                    GOD_IDS.forEach(id => {
                        if (Array.isArray(data[id])) {
                            const validArr = data[id].filter(n => Number.isInteger(n) && n>=0 && n<=2);
                            const unique = [...new Set(validArr)].slice(0,3);
                            if (unique.length > 0) {
                                safeData[id] = unique;
                                count++;
                            }
                        }
                    });
                    
                    godProgress = safeData;
                    saveToLocalStorage();
                    renderGame();
                    showToast(`${count} Götter geladen!`);
                } catch(err) { showToast('Defekte Datei', 'error'); }
            };
            reader.readAsText(file);
            e.target.value = null;
        }

        function downloadReport() {
            let content = "SPIEL-STATISTIK\n================\n";
            content += "Datum: " + new Date().toLocaleDateString() + "\n";
            content += "Richtig: " + gameStats.correct + "\n";
            content += "Falsch: " + gameStats.wrong + "\n";
            const dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(content);
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "olymp-statistik.txt");
            document.body.appendChild(dlAnchor);
            dlAnchor.click();
            document.body.removeChild(dlAnchor);
        }

        function resetGame() {
            confirmAction("Wirklich alles löschen?", () => {
                godProgress = Object.create(null);
                gameStats = { correct: 0, wrong: 0, startTime: Date.now() };
                saveToLocalStorage();
                document.getElementById('win-screen').style.display = 'none';
                renderGame();
                showToast('Spiel zurückgesetzt');
            });
        }

        function setupEventListeners() {
            document.getElementById('btn-save').addEventListener('click', downloadSave);
            document.getElementById('btn-load').addEventListener('click', triggerUpload);
            document.getElementById('btn-reset').addEventListener('click', resetGame);
            document.getElementById('fileInput').addEventListener('change', uploadSave);
            document.getElementById('btn-close-modal').addEventListener('click', closeModal);
            document.getElementById('btn-download-report').addEventListener('click', downloadReport);
            document.getElementById('btn-view-olymp').addEventListener('click', () => document.getElementById('win-screen').style.display = 'none');
            document.getElementById('btn-new-game').addEventListener('click', resetGame);
            
            // ESC Key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('modal-backdrop');
                    const win = document.getElementById('win-screen');
                    const confirm = document.getElementById('confirm-modal');
                    if (confirm.style.display === 'flex') confirm.style.display = 'none';
                    else if (modal.classList.contains('active')) closeModal();
                    else if (win.style.display === 'flex') win.style.display = 'none';
                }
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadFromLocalStorage();
            renderGame();
        });

    </script>
</body>
</html>
