<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sowi-Guardian 2042: Secure Protocol</title>
    <style>
        /* CSS bleibt weitgehend identisch, Fokus liegt auf JS-Sicherheit */
        :root {
            --neon-cyan: #06b6d4;
            --neon-blue: #3b82f6;
            --neon-purple: #a855f7;
            --neon-amber: #f59e0b;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --bg-dark: #020617;
            --card-glass: rgba(10, 20, 40, 0.90); /* Etwas dunkler f√ºr Lesbarkeit */
            --border-glow: rgba(6, 182, 212, 0.3);
            --scanline-color: rgba(0, 255, 255, 0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Inter', 'Courier New', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
            color: #f8fafc; margin: 0; padding: 0;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            perspective: 1000px;
        }

        /* CRT Scanline Effect */
        body::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, var(--scanline-color) 50%, transparent 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 9999;
            animation: scanlines 0.2s linear infinite;
            opacity: 0.6;
        }

        @keyframes scanlines { from { transform: translateY(0); } to { transform: translateY(4px); } }

        /* Background Particles */
        .particle {
            position: absolute; background: var(--neon-cyan); border-radius: 50%; opacity: 0.2;
            animation: floatUp linear infinite; pointer-events: none; z-index: 0;
        }
        @keyframes floatUp { 
            0% { transform: translateY(110vh) scale(0); opacity: 0; } 
            50% { opacity: 0.5; }
            100% { transform: translateY(-10vh) scale(1); opacity: 0; } 
        }

        /* Screen Transitions */
        .screen {
            flex: 1; display: none; padding: 20px;
            max-width: 1000px; margin: 0 auto; width: 100%;
            flex-direction: column; justify-content: center;
            opacity: 0; transform: scale(0.98);
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }
        .active { display: flex; opacity: 1; transform: scale(1); }

        /* Card Styles */
        .card {
            background: var(--card-glass); border: 1px solid var(--border-glow);
            border-radius: 24px; padding: 30px; 
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.1), inset 0 0 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(12px);
            position: relative; overflow: hidden;
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan), var(--neon-green));
            animation: borderRun 3s infinite linear;
        }
        @keyframes borderRun { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* HUD */
        #hud {
            padding: 15px 25px; background: rgba(5, 10, 20, 0.9);
            border-bottom: 1px solid var(--neon-cyan);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .hud-stat { text-align: center; }
        .hud-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--neon-cyan); }
        .hud-value { font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: 900; color: #fff; text-shadow: 0 0 10px var(--neon-cyan); }

        h1, h2 { text-transform: uppercase; letter-spacing: 1px; }
        .sector-tag { color: var(--neon-amber); font-weight: 800; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 5px; }
        
        .data-stream {
            background: rgba(0,0,0,0.6); padding: 25px; border-radius: 16px;
            font-size: 1.25rem; line-height: 1.6; border-left: 4px solid var(--neon-cyan);
            margin: 20px 0; max-height: 40vh; overflow-y: auto;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
        }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button {
            padding: 22px; border: none; border-radius: 16px;
            font-size: 1.1rem; font-weight: 800; cursor: pointer;
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
            position: relative; overflow: hidden;
        }
        button::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), transparent);
            opacity: 0; transition: opacity 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        button:hover::after { opacity: 1; }
        button:active { transform: scale(0.96); }

        .btn-v { background: linear-gradient(135deg, var(--neon-green), #047857); color: white; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .btn-a { background: linear-gradient(135deg, var(--neon-blue), #1d4ed8); color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        .btn-p { background: var(--neon-cyan); color: #000; width: 100%; box-shadow: 0 0 20px var(--border-glow); }
        .btn-danger { background: var(--neon-red); color: white; width: 100%; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); animation: pulseRed 1s infinite; }

        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .terminal-box {
            font-family: 'Courier New', monospace; background: #000; color: var(--neon-green);
            padding: 20px; border-radius: 10px; border: 1px solid var(--neon-green);
            min-height: 150px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.4;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
            white-space: pre-wrap; /* Wichtig f√ºr textContent mit \n */
        }
        .cursor { display: inline-block; width: 8px; height: 15px; background: var(--neon-green); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #suchsel-container {
            display: grid; grid-template-columns: repeat(12, 1fr);
            gap: 6px; background: rgba(0,0,0,0.4); padding: 15px;
            border-radius: 16px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.1);
        }
        .letter {
            aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); border-radius: 6px;
            font-weight: bold; font-size: 1rem; color: var(--neon-cyan);
            cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .letter:active { background: var(--neon-purple); color: white; }
        .letter.found { 
            background: var(--neon-green); color: black; 
            box-shadow: 0 0 15px var(--neon-green); 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .word-tag {
            padding: 6px 12px; background: rgba(59, 130, 246, 0.2); 
            border: 1px solid var(--neon-blue); border-radius: 20px;
            font-size: 0.8rem; transition: all 0.3s;
        }
        .word-tag.done { background: var(--neon-green); color: black; border-color: var(--neon-green); text-decoration: line-through; opacity: 0.6; }

        #game-box, #penalty-area {
            width: 100%; height: 350px; background: #000;
            border-radius: 20px; position: relative; overflow: hidden;
            border: 1px solid var(--neon-purple); display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 30px rgba(168, 85, 247, 0.2);
        }

        .target {
            position: absolute; width: 70px; height: 70px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; background: var(--neon-purple); cursor: pointer;
            box-shadow: 0 0 20px var(--neon-purple); z-index: 10;
            animation: float 2s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .key-btn {
            width: 65px; height: 65px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--neon-cyan); color: white; border-radius: 12px;
            font-size: 1.4rem; font-weight: bold; cursor: pointer; transition: all 0.1s;
        }
        .key-btn:active { background: var(--neon-cyan); color: black; transform: scale(0.9); }

        #modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            display:none; z-index: 5000; justify-content: center; align-items: center; padding: 20px;
        }
        .modal {
            background: #0f172a; border: 2px solid var(--neon-cyan);
            border-radius: 24px; padding: 30px; max-width: 500px; width: 100%;
            text-align: center; box-shadow: 0 0 50px rgba(6, 182, 212, 0.3);
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div id="particles"></div>

    <div id="hud">
        <div class="hud-stat">
            <div class="hud-label">Status</div>
            <div id="hud-mode" class="hud-value" style="color:var(--neon-green)">ONLINE</div>
        </div>
        <div class="hud-stat">
            <div class="hud-label">Uptime</div>
            <div id="hud-timer" class="hud-value">10:00</div>
        </div>
        <div class="hud-stat">
            <div class="hud-label">Grundrechte</div>
            <div id="hud-progress" class="hud-value">0/19</div>
        </div>
    </div>

    <!-- SCREENS -->
    <div id="screen-start" class="screen active">
        <div class="card">
            <h1 style="text-align:center; color: var(--neon-cyan); text-shadow: 0 0 15px var(--neon-cyan);">GUARDIAN 2042</h1>
            <div class="terminal-box">
                <span id="typewriter-text"></span><span class="cursor">_</span>
            </div>
            <p style="text-align:center; font-size: 0.9rem; color: #94a3b8; margin-top: -10px;">
                Secure Connection Established.<br>Waiting for User Input...
            </p>
            <button class="btn-p" id="btn-boot" style="display:none; margin-top: 15px;">SYSTEM BOOTEN</button>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="card">
            <div class="sector-tag" id="quiz-sector"></div>
            <div style="display:flex; justify-content:space-between; align-items: center; margin:10px 0;">
                <h2 id="quiz-title" style="margin:0; font-size: 1.4rem;"></h2>
                <div id="article-tag" style="background:var(--neon-amber); color:#000; padding:4px 12px; border-radius:8px; font-weight:800; font-size: 0.9rem;"></div>
            </div>
            <div class="data-stream" id="quiz-text"></div>
            <div class="btn-grid">
                <button class="btn-v" id="btn-valid">VALID</button>
                <button class="btn-a" id="btn-fake">KI-FAKE</button>
            </div>
        </div>
    </div>

    <div id="screen-mini" class="screen">
        <div class="card">
            <h2 id="mini-name" style="text-align:center; color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple);"></h2>
            <p id="mini-task" style="text-align:center; color: #e2e8f0; margin-bottom: 20px;"></p>
            <div id="game-box"></div>
            <div id="mini-stat" style="text-align:center; margin-top:15px; font-family:monospace; color:var(--neon-cyan); font-weight: bold;">INITIALISIERUNG...</div>
        </div>
    </div>

    <div id="screen-penalty" class="screen">
        <div class="card" style="border-color: var(--neon-red);">
            <h2 style="text-align:center; color: var(--neon-red); animation: blink 0.5s infinite;">KRITISCHER FEHLER</h2>
            <p style="text-align:center;">Manuelle Reparatur erforderlich! Entferne die Bugs.</p>
            <div id="penalty-area" style="border-color: var(--neon-red);"></div>
            <div style="text-align:center; margin-top:10px; font-weight:bold;">Status: <span id="penalty-count">0</span>/5 Bugs</div>
        </div>
    </div>

    <div id="screen-end" class="screen">
        <div class="card" style="text-align:center;">
            <h1 id="end-title" style="color: var(--neon-cyan);">MISSION COMPLETE</h1>
            <p style="font-size: 1.1rem; margin-bottom: 20px;">Die demokratische Grundordnung wurde erfolgreich verteidigt.</p>
            <div id="article-map" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin:20px 0;"></div>
            <br>
            <button class="btn-p" id="btn-bonus" style="background: var(--neon-purple); color: white; margin-bottom: 15px;">BONUS LEVEL STARTEN</button>
            <button class="btn-p" id="btn-restart">NEUSTART</button>
        </div>
    </div>

    <div id="screen-final" class="screen">
        <div class="card">
            <h1 style="text-align:center; color: var(--neon-green); text-shadow: 0 0 15px var(--neon-green);">BONUS LEVEL</h1>
            <p style="text-align:center; color: #cbd5e1;">Entschl√ºssele die Datenbank: Finde 5 Begriffe!</p>
            <div id="suchsel-container"></div>
            <div id="word-list" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:10px;"></div>
            <br>
             <button class="btn-p" id="btn-reboot">SYSTEM REBOOT</button>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <div id="modal-icon" style="font-size:4rem; margin-bottom: 10px;"></div>
            <h2 id="modal-title"></h2>
            <div id="modal-body" style="margin:20px 0; line-height:1.5; color: #e2e8f0;"></div>
            <button class="btn-p" id="modal-btn">WEITER</button>
        </div>
    </div>

    <script>
        /**
         * SECURE GAME ENGINE
         * Wrapped in IIFE to prevent global scope pollution (Anti-Cheat)
         */
        (function() {
            // --- CONSTANTS ---
            const QUESTIONS = [
                { s: "Q1.1 Wirtschaft", t: "EZB Strategie", c: "Das Inflationsziel der EZB ist symmetrisch und liegt bei exakt 2% auf mittlere Sicht.", ai: false, e: "Korrekt. Das Ziel wurde 2021 zur besseren Steuerung angepasst." },
                { s: "Q1.1 Wirtschaft", t: "BIP-Analyse", c: "Das BIP misst den Wohlstand perfekt, da es auch Schwarzarbeit und unbezahlte Pflegearbeit pr√§zise mit einrechnet.", ai: true, e: "KI-Halluzination! Unbezahlte Arbeit wird im BIP nicht erfasst." },
                { s: "Q1.2 EU", t: "Ordentliches Verfahren", c: "Im ordentlichen Gesetzgebungsverfahren entscheiden Kommission und Parlament ohne den Rat der EU.", ai: true, e: "Falsch. Der Rat der EU (Ministerrat) ist zwingender Teil der Legislative." },
                { s: "Q1.2 EU", t: "Subsidiarit√§t", c: "Aufgaben sollen auf der kleinstm√∂glichen Ebene gel√∂st werden; die EU greift nur bei grenz√ºberschreitenden Notwendigkeiten ein.", ai: false, e: "Richtiges Subsidiarit√§tsprinzip." },
                { s: "Q2.1 Sozialstruktur", t: "Schichten-Modell", c: "Das Modell von Gei√üler basiert prim√§r auf der Trennung zwischen digitaler Elite und analogen Verlierern.", ai: true, e: "Falsch. Gei√üler nutzt Berufsposition und Einkommen, 'Digitale Elite' ist kein Teil seines klassischen Hauses." },
                { s: "Q2.1 Sozialstruktur", t: "Gini-Koeffizient", c: "Ein Gini von 0 bedeutet totale Einkommensgleichheit, 1 bedeutet totale Ungleichheit.", ai: false, e: "Korrekt definiert." },
                { s: "Q2.2 Globales", t: "UN-Sicherheitsrat", c: "Der UN-Sicherheitsrat besteht aus 5 st√§ndigen und 10 nicht-st√§ndigen Mitgliedern.", ai: false, e: "Korrekt." },
                { s: "Q2.2 Globales", t: "NATO-B√ºndnisfall", c: "Nach Artikel 5 muss jedes Mitglied bei einem Angriff sofort mit Atombomben antworten, ohne Absprache.", ai: true, e: "Gef√§hrliche Halluzination! Artikel 5 sieht Beistand vor, die Wahl der Mittel liegt beim Mitgliedstaat." },
                { s: "Q1.1 Wirtschaft", t: "Stabilit√§tsgesetz", c: "Das 'Magische Viereck' beinhaltet u.a. ein qualitatives Wachstum unter Ber√ºcksichtigung der √ñkologie.", ai: true, e: "Falsch. Das Original-Gesetz von 1967 fordert 'quantitatives' (stetiges/angemessenes) Wachstum. √ñkologie kam erst sp√§ter (Sechseck)." },
                { s: "Q1.2 EU", t: "Spitzenkandidat", c: "Das Spitzenkandidaten-Prinzip ist rechtlich bindend im EU-Vertrag von Lissabon verankert.", ai: true, e: "Falsch. Es ist eine informelle politische Praxis, kein Gesetz." },
                { s: "Q2.1 Sozialstruktur", t: "Demografischer Wandel", c: "Die Geburtenrate in DE liegt seit den 70ern konstant bei 2,1 Kindern pro Frau.", ai: true, e: "Falsch. Sie liegt deutlich darunter, meist zwischen 1,4 und 1,6." },
                { s: "Q2.2 Globales", t: "WTO Aufgaben", c: "Die WTO √ºberwacht den weltweiten Emissionshandel und legt CO2-Steuern f√ºr alle Kontinente fest.", ai: true, e: "Falsch. Das ist Aufgabe von Umweltorganisationen/Staaten. Die WTO regelt Welthandel/Z√∂lle." },
                { s: "Q1.1 Wirtschaft", t: "Konjunkturphasen", c: "Die vier Phasen sind Aufschwung, Boom (Hochkonjunktur), Abschwung (Rezession) und Depression (Tiefphase).", ai: false, e: "Korrekt. Das klassische Konjunkturzyklus-Modell." },
                { s: "Q1.2 EU", t: "Richtlinien vs. Verordnungen", c: "Eine EU-Verordnung gilt unmittelbar in jedem Mitgliedstaat, eine Richtlinie muss erst in nationales Recht umgesetzt werden.", ai: false, e: "Korrekt. Wichtige Unterscheidung der Rechtsakte." },
                { s: "Q2.1 Sozialstruktur", t: "Entstrukturierung", c: "Die Entstrukturierungsthese besagt, dass sich Klassenbindungen aufl√∂sen und Lebensstile wichtiger werden.", ai: false, e: "Korrekt (nach Beck/Gei√üler)." },
                { s: "Q1.1 Wirtschaft", t: "Schuldenbremse", c: "Die Schuldenbremse erlaubt dem Bund eine strukturelle Neuverschuldung von maximal 0,35% des BIP.", ai: false, e: "Korrekt. Verankert in Art. 109 GG." },
                { s: "Q1.2 EU", t: "Einstimmigkeit", c: "In der Gemeinsamen Au√üen- und Sicherheitspolitik (GASP) entscheidet der Rat meistens mit qualifizierter Mehrheit.", ai: true, e: "Falsch. In der GASP gilt in der Regel das Einstimmigkeitsprinzip." },
                { s: "Q2.1 Sozialstruktur", t: "Prekarisierung", c: "Atypische Besch√§ftigungsverh√§ltnisse (Leiharbeit, Minijobs) haben in den letzten 20 Jahren abgenommen.", ai: true, e: "Falsch. Sie haben deutlich zugenommen." },
                { s: "Q2.2 Globales", t: "Menschenrechte", c: "Die Allgemeine Erkl√§rung der Menschenrechte von 1948 ist v√∂lkerrechtlich bindend und einklagbar.", ai: true, e: "Falsch. Sie ist eine UN-Resolution und kein bindender Vertrag, hat aber hohes Gewohnheitsrecht." },
                { s: "Q1.1 Wirtschaft", t: "Angebotspolitik", c: "Der Monetarismus fordert staatliche Investitionsprogramme (Deficit Spending) in Krisenzeiten.", ai: true, e: "Falsch. Das ist Keynesianismus. Monetaristen wollen Geldmengensteuerung." }
            ];

            const GG = [
                "Menschenw√ºrde", "Handlungsfreiheit", "Gleichheit", "Glauben", "Meinung", "Ehe", "Schule", 
                "Versammlung", "Vereine", "Briefgeheimnis", "Freiz√ºgigkeit", "Beruf", "Wohnung", "Eigentum", 
                "Enteignung", "Staatsangeh√∂rigkeit", "Asyl", "Petition", "Rechtsweg"
            ];

            // --- SECURITY UTILS ---

            // Timer Manager: Prevents multiple intervals running simultaneously
            const TimerManager = {
                timers: {},
                start: function(name, callback, ms) {
                    if (this.timers[name]) clearInterval(this.timers[name]);
                    this.timers[name] = setInterval(callback, ms);
                },
                stop: function(name) {
                    if (this.timers[name]) {
                        clearInterval(this.timers[name]);
                        delete this.timers[name];
                    }
                },
                stopAll: function() {
                    for (let key in this.timers) {
                        clearInterval(this.timers[key]);
                    }
                    this.timers = {};
                }
            };

            // Sanitizer: Only allows simple formatting tags, escapes everything else
            function setSafeHTML(elementId, content) {
                const el = document.getElementById(elementId);
                if (!el) return;
                
                // Whitelist approach: Replace allowed tags with placeholders, escape rest, restore tags
                let safe = content
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");

                // Restore whitelisted tags (<b>, <strong>, <br>, <i>)
                // We use a specific decoding map for strict control
                safe = safe
                    .replace(/&lt;b&gt;/g, "<b>").replace(/&lt;\/b&gt;/g, "</b>")
                    .replace(/&lt;strong&gt;/g, "<strong>").replace(/&lt;\/strong&gt;/g, "</strong>")
                    .replace(/&lt;br&gt;/g, "<br>")
                    .replace(/&lt;i&gt;/g, "<i>").replace(/&lt;\/i&gt;/g, "</i>");
                
                el.innerHTML = safe;
            }

            // --- STATE MANAGEMENT ---
            let state = {
                score: 0,
                qIdx: 0,
                timeLeft: 600,
                active: false,
                shuffled: [],
                modalAction: null,
                completedMinis: []
            };

            // --- DOM ELEMENTS (Cached) ---
            const ui = {
                screens: document.querySelectorAll('.screen'),
                hudTimer: document.getElementById('hud-timer'),
                hudProgress: document.getElementById('hud-progress'),
                hudMode: document.getElementById('hud-mode'),
                quizSector: document.getElementById('quiz-sector'),
                quizTitle: document.getElementById('quiz-title'),
                quizText: document.getElementById('quiz-text'),
                articleTag: document.getElementById('article-tag'),
                modal: document.getElementById('modal-overlay'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalIcon: document.getElementById('modal-icon')
            };

            // --- SCREEN MANAGER ---
            function showScreen(screenId) {
                // Security: Stop all mini-game loops when switching screens
                if (screenId !== 'screen-mini' && screenId !== 'screen-quiz') {
                    TimerManager.stop('minigame_spawn');
                    TimerManager.stop('minigame_check');
                }
                
                ui.screens.forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }

            // --- BOOT SEQUENCE ---
            document.getElementById('btn-boot').addEventListener('click', () => {
                state.active = true;
                state.shuffled = [...QUESTIONS].sort(() => Math.random() - 0.5);
                showScreen('screen-quiz');
                startMainTimer();
                renderQuestion();
            });

            function startMainTimer() {
                TimerManager.start('main', () => {
                    if(!state.active) return;
                    state.timeLeft--;
                    const m = Math.floor(state.timeLeft/60), s = state.timeLeft%60;
                    ui.hudTimer.textContent = `${m}:${s<10?'0':''}${s}`;
                    if(state.timeLeft <= 0) {
                        TimerManager.stopAll();
                        alert("ZEIT ABGELAUFEN! System Shutdown.");
                        location.reload();
                    }
                }, 1000);
            }

            // --- QUIZ LOGIC ---
            function renderQuestion() {
                // UPDATE HUD FIRST to ensure 19/19 is shown before redirect
                ui.hudProgress.textContent = `${state.score}/19`;

                // Mini-Game Trigger
                if((state.score === 5 || state.score === 12) && !state.completedMinis.includes(state.score)) {
                    triggerMiniGame();
                    return;
                }
                // End Condition
                if(state.score >= 19) {
                    endMission();
                    return;
                }
                // Question Pool Reset Fallback
                if(state.qIdx >= state.shuffled.length) {
                    state.shuffled = [...QUESTIONS].sort(() => Math.random() - 0.5);
                    state.qIdx = 0;
                }

                const q = state.shuffled[state.qIdx];
                ui.quizSector.textContent = q.s;
                ui.quizTitle.textContent = q.t;
                // Safe content rendering
                setSafeHTML('quiz-text', q.c);
                ui.articleTag.textContent = `Art. ${state.score + 1}`;
                // Keep progress update here as well for standard flow
                ui.hudProgress.textContent = `${state.score}/19`;
            }

            document.getElementById('btn-valid').addEventListener('click', () => validate(false));
            document.getElementById('btn-fake').addEventListener('click', () => validate(true));

            function validate(userSaidAI) {
                const q = state.shuffled[state.qIdx];
                const win = (userSaidAI === q.ai);
                const btn = document.getElementById('modal-btn');
                
                if (win) {
                    const artName = GG[state.score];
                    showModal(true, "DATENSTROM STABIL", 
                        `<b>Artikel ${state.score + 1} (${artName}) gesichert.</b><br><br>${q.e}`, 
                        "‚úÖ");
                    state.score++;
                    state.modalAction = 'next';
                    btn.className = "btn-p";
                    btn.textContent = "SYSTEM HOCHFAHREN";
                } else {
                    showModal(false, "SYSTEM-ABSTURZ", 
                        `Die KI-Korruption war zu stark.<br>${q.e}<br><br><strong style='color:var(--neon-red)'>STRAFE: MANUELLE REPARATUR N√ñTIG</strong>`, 
                        "‚ö†Ô∏è");
                    state.modalAction = 'penalty';
                    btn.className = "btn-danger";
                    btn.textContent = "REPARATUR STARTEN";
                }
                state.qIdx++;
            }

            // --- MODAL SYSTEM ---
            function showModal(win, title, body, icon) {
                ui.modalTitle.textContent = title;
                ui.modalTitle.style.color = win ? "var(--neon-green)" : "var(--neon-red)";
                setSafeHTML('modal-body', body);
                ui.modalIcon.textContent = icon;
                ui.modal.style.display = 'flex';
            }

            document.getElementById('modal-btn').addEventListener('click', () => {
                ui.modal.style.display = 'none';
                if (state.modalAction === 'penalty') startPenaltyTask();
                else renderQuestion();
            });

            // --- PENALTY TASK ---
            function startPenaltyTask() {
                showScreen('screen-penalty');
                const area = document.getElementById('penalty-area');
                area.innerHTML = ""; // Safe here, container clearing
                let fixed = 0;
                document.getElementById('penalty-count').textContent = "0";

                const btn = document.createElement('button');
                btn.className = "glitch-btn";
                btn.textContent = "BUG L√ñSCHEN";
                btn.style.position = 'absolute';
                btn.style.padding = '15px 30px';
                btn.style.background = 'var(--neon-red)';
                btn.style.border = 'none';
                btn.style.borderRadius = '8px';
                btn.style.color = 'white';
                btn.style.fontWeight = 'bold';
                
                function moveBtn() {
                    // Boundary checks
                    const maxX = area.clientWidth - 150;
                    const maxY = area.clientHeight - 60;
                    const x = Math.max(0, Math.random() * maxX);
                    const y = Math.max(0, Math.random() * maxY);
                    btn.style.left = x + "px";
                    btn.style.top = y + "px";
                }

                btn.onclick = () => {
                    fixed++;
                    document.getElementById('penalty-count').textContent = fixed;
                    if(fixed >= 5) {
                        btn.remove();
                        setTimeout(() => {
                            showScreen('screen-quiz');
                            renderQuestion();
                        }, 500);
                    } else {
                        moveBtn();
                    }
                };
                
                area.appendChild(btn);
                moveBtn();
            }

            // --- MINI GAMES ---
            function triggerMiniGame() {
                showScreen('screen-mini');
                ui.hudMode.textContent = "HACKING";
                if(state.score === 5) runNeuralTap();
                else runSequenceBreach();
            }

            function runNeuralTap() {
                const box = document.getElementById('game-box');
                box.innerHTML = "";
                let hits = 0;
                document.getElementById('mini-name').textContent = "NEURAL TAP";
                document.getElementById('mini-task').textContent = "Klicke schnell auf 8 Viren-Knoten!"; 

                // Use TimerManager for cleanup safety
                TimerManager.start('minigame_spawn', () => {
                    const t = document.createElement('div');
                    t.className = 'target';
                    t.style.left = Math.random()*80 + "%";
                    t.style.top = Math.random()*80 + "%";
                    t.textContent = "üëæ";
                    t.onclick = () => { hits++; t.remove(); checkNeuralProgress(hits); };
                    box.appendChild(t);
                    
                    setTimeout(() => { 
                        if(t.parentNode) t.remove(); 
                    }, 2000); 
                }, 1100);

                function checkNeuralProgress(hits) {
                    document.getElementById('mini-stat').textContent = `PROGRESS: ${hits}/8`;
                    if(hits >= 8) {
                        TimerManager.stop('minigame_spawn');
                        alert("BELOHNUNG: Firewall durchbrochen! +30s Zeit-Boost");
                        state.timeLeft += 30;
                        finishMini();
                    }
                }
            }

            function runSequenceBreach() {
                const box = document.getElementById('game-box');
                document.getElementById('mini-name').textContent = "SEQUENCE BREACH";
                document.getElementById('mini-task').textContent = "Merke dir den Code (3 Sekunden)!";
                document.getElementById('mini-stat').textContent = "Verschl√ºsselung...";

                box.innerHTML = "";
                const display = document.createElement('div');
                display.style.fontSize = '3rem';
                display.style.marginTop = '20px';
                display.style.marginBottom = '20px';
                display.style.color = 'var(--neon-green)';
                display.style.fontWeight = 'bold';
                box.appendChild(display);

                const code = Math.floor(10000 + Math.random()*90000).toString(); 
                display.textContent = code;
                
                setTimeout(() => {
                    display.textContent = "_ _ _ _ _";
                    document.getElementById('mini-task').textContent = "Code √ºber das Pad eingeben:";
                    createKeypad(box, code);
                }, 3000);
            }

            function createKeypad(container, targetCode) {
                const pad = document.createElement('div');
                pad.className = 'keypad-grid';
                let input = "";
                const display = container.querySelector('div');

                for(let i=1; i<=9; i++) createKey(i);
                createKey(0, 2);

                function createKey(num, gridCol) {
                    const btn = document.createElement('button');
                    btn.textContent = num;
                    btn.className = 'key-btn';
                    if(gridCol) btn.style.gridColumn = gridCol;
                    btn.onclick = () => {
                        if(input.length < 5) {
                            input += num;
                            display.textContent = input;
                            if(input.length === 5) {
                                if(input === targetCode) {
                                    setTimeout(() => {
                                        alert("BELOHNUNG: Zugriff gew√§hrt! +1 Bonus-Artikel");
                                        state.score++;
                                        finishMini();
                                    }, 300);
                                } else {
                                    setTimeout(() => {
                                        alert("FALSCHER CODE! Neustart.");
                                        runSequenceBreach();
                                    }, 300);
                                }
                            }
                        }
                    };
                    pad.appendChild(btn);
                }
                container.appendChild(pad);
            }

            function finishMini() {
                state.completedMinis.push(state.score);
                showScreen('screen-quiz');
                ui.hudMode.textContent = "ONLINE";
                renderQuestion();
            }

            function endMission() {
                showScreen('screen-end');
                const map = document.getElementById('article-map');
                map.innerHTML = ""; 
                GG.forEach((n, i) => {
                    const d = document.createElement('div');
                    d.textContent = `Art. ${i+1}`; 
                    d.style.background = "var(--neon-green)";
                    d.style.color = "black"; d.style.padding = "8px"; 
                    d.style.borderRadius = "6px";
                    d.style.fontSize = "0.7rem";
                    map.appendChild(d);
                });
            }

            // --- BONUS LEVEL (Robust Suchsel) ---
            document.getElementById('btn-bonus').addEventListener('click', startSuchsel);
            document.getElementById('btn-restart').addEventListener('click', () => location.reload());
            document.getElementById('btn-reboot').addEventListener('click', () => location.reload());

            function startSuchsel() {
                showScreen('screen-final');
                const words = ["FREIHEIT", "DEMOKRATIE", "PLURALISMUS", "VERFASSUNG", "PARTEI"];
                const gridSize = 12; 
                const grid = Array(gridSize * gridSize).fill(null);
                
                // Robust Generator with retry limit
                words.forEach(word => {
                    let placed = false;
                    let attempts = 0;
                    while (!placed && attempts < 100) {
                        attempts++;
                        const direction = Math.random() > 0.5 ? 'H' : 'V';
                        const startRow = Math.floor(Math.random() * gridSize);
                        const startCol = Math.floor(Math.random() * gridSize);
                        
                        if (canPlace(grid, word, startRow, startCol, direction, gridSize)) {
                            placeWord(grid, word, startRow, startCol, direction, gridSize);
                            placed = true;
                        }
                    }
                    if(!placed) console.warn("Konnte Wort nicht platzieren:", word);
                });

                // Fill with random letters
                const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                for (let i = 0; i < grid.length; i++) {
                    if (!grid[i]) grid[i] = letters.charAt(Math.floor(Math.random() * letters.length));
                }

                // Render DOM (Safe)
                const container = document.getElementById('suchsel-container');
                container.innerHTML = "";
                grid.forEach((l) => {
                    const d = document.createElement('div');
                    d.className = 'letter';
                    d.textContent = l;
                    d.onclick = () => d.classList.toggle('found');
                    container.appendChild(d);
                });

                const wl = document.getElementById('word-list');
                wl.innerHTML = "";
                let foundCount = 0;
                words.forEach(w => {
                    const s = document.createElement('div');
                    s.className = 'word-tag';
                    s.textContent = w;
                    s.onclick = () => { 
                        if(!s.classList.contains('done')) {
                            s.classList.add('done'); 
                            foundCount++;
                            if (foundCount >= words.length) {
                                setTimeout(() => {
                                    alert("BONUS LEVEL ABGESCHLOSSEN! Alle Datenbanken gesichert.");
                                    showScreen('screen-end');
                                }, 500);
                            }
                        }
                    };
                    wl.appendChild(s);
                });
            }

            // Grid Logic Helpers
            function canPlace(grid, word, r, c, dir, size) {
                if (dir === 'H') {
                    if (c + word.length > size) return false;
                    for (let i = 0; i < word.length; i++) {
                        const idx = r * size + (c + i);
                        if (grid[idx] !== null && grid[idx] !== word[i]) return false;
                    }
                } else {
                    if (r + word.length > size) return false;
                    for (let i = 0; i < word.length; i++) {
                        const idx = (r + i) * size + c;
                        if (grid[idx] !== null && grid[idx] !== word[i]) return false;
                    }
                }
                return true;
            }

            function placeWord(grid, word, r, c, dir, size) {
                for (let i = 0; i < word.length; i++) {
                    const idx = dir === 'H' ? r * size + (c + i) : (r + i) * size + c;
                    grid[idx] = word[i];
                }
            }

            // --- PARTICLES INIT ---
            function initParticles() {
                const container = document.getElementById('particles');
                for(let i=0; i<20; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.left = Math.random() * 100 + 'vw';
                    p.style.width = Math.random() * 10 + 5 + 'px';
                    p.style.height = p.style.width;
                    p.style.animationDuration = Math.random() * 5 + 5 + 's';
                    p.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(p);
                }
            }
            initParticles();

            // --- TYPEWRITER INTRO ---
            const bootText = "INITIALIZING GUARDIAN PROTOCOL...\nLOADING KERNEL... OK\nCHECKING INTEGRITY... OK\nCONNECTING TO BASIC LAW DATABASE...\n\nACCESS GRANTED.\n\nWARNUNG: KI-Desinformation entdeckt.\nMISSION: Retten Sie Art. 1-19.";
            let typeIdx = 0;
            const twEl = document.getElementById("typewriter-text");
            
            function typeWriter() {
                if (typeIdx < bootText.length) {
                    const char = bootText.charAt(typeIdx);
                    if(char === "\n") twEl.appendChild(document.createElement("br"));
                    else twEl.appendChild(document.createTextNode(char));
                    typeIdx++;
                    setTimeout(typeWriter, Math.random() * 30 + 20);
                } else {
                    const b = document.getElementById('btn-boot');
                    b.style.display = 'block';
                    b.classList.add('popIn');
                }
            }
            setTimeout(typeWriter, 500);

        })(); // End of IIFE
    </script>
</body>
</html>
