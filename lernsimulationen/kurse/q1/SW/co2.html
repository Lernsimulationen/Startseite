<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO₂-Preis: Steuerungsdilemma (Secure)</title>
    <style>
        /* --- Design-System (CSS Variablen) --- */
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --light: #ecf0f1;
            --text: #2c3e50;
            --bg: #fdfdfd;
            --border-radius: 6px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            /* Verhindert Pull-to-Refresh auf iPads, was das Spiel stören könnte */
            overscroll-behavior: none;
        }

        /* --- Header / Dashboard --- */
        #dashboard-container {
            background-color: var(--primary);
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            z-index: 10;
        }
        
        canvas#hud {
            background-color: #fff;
            border-radius: var(--border-radius);
            width: 100%; 
            height: 80px;
            max-width: 800px;
            display: block;
        }

        /* --- Hauptbereich --- */
        #game-area {
            display: flex;
            flex: 1;
            overflow: hidden; /* Scrollen nur in Panels */
            position: relative;
        }

        /* Info Panel (Links) */
        #info-panel {
            width: 30%;
            background-color: var(--light);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #bdc3c7;
            box-sizing: border-box;
        }

        #info-panel h2 {
            color: var(--primary);
            margin-top: 0;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 5px;
        }

        #info-panel p {
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Interaktions Panel (Rechts) */
        #interaction-panel {
            width: 70%;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* --- UI Komponenten --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px; /* Größere Touch-Targets für iPad */
            margin: 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s, transform 0.1s;
            user-select: none;
        }
        .btn:hover:not(:disabled) { background-color: var(--secondary); }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn:disabled { 
            background-color: #95a5a6; 
            cursor: not-allowed; 
            opacity: 0.7; 
        }
        
        .btn-option { 
            width: 100%; 
            max-width: 600px; 
            text-align: left; 
            margin-bottom: 12px; 
            border: 1px solid #ddd; 
            color: var(--text); 
            background: white; 
            display: block;
        }
        .btn-option:hover:not(:disabled) { background-color: #f0f0f0; }
        .btn-option.selected { border-color: var(--accent); background-color: #e8f8f5; }

        /* Drag & Drop */
        .dnd-container {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .drop-zone {
            width: 45%;
            min-height: 160px;
            border: 2px dashed #bdc3c7;
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s;
        }
        .drop-zone.drag-over { background-color: #e8f8f5; border-color: var(--accent); }
        .drop-zone h4 { margin-top: 0; text-align: center; color: var(--secondary); width: 100%; pointer-events: none; }
        
        .draggable {
            background-color: var(--primary);
            color: white;
            padding: 10px 14px; /* Touch-freundlich */
            margin: 6px;
            border-radius: 4px;
            cursor: grab;
            font-size: 0.95rem;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            user-select: none; 
            touch-action: none; /* Wichtig für Drag Events auf manchen Geräten */
        }
        .draggable:active { cursor: grabbing; }
        .draggable.correct { background-color: var(--accent); border: 2px solid #1e8449; }
        .draggable.wrong { background-color: var(--danger); border: 2px solid #922b21; }

        #dnd-items {
            margin-top: 20px; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
            min-height: 100px;
            width: 100%;
            text-align: center;
            background-color: #fafafa;
            border-radius: var(--border-radius);
        }

        /* Slider */
        .slider-container {
            width: 80%;
            margin: 30px 0;
            text-align: center;
        }
        input[type=range] {
            width: 100%;
            height: 25px; /* Größer für Touch */
            cursor: pointer;
        }

        /* Feedback Styles */
        #feedback-area {
            min-height: 20px;
            margin-top: 20px;
            padding: 10px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        .feedback-positive { color: var(--accent); font-weight: bold; background: #e8f8f5; padding: 10px; border-radius: 4px; display: block;}
        .feedback-negative { color: var(--danger); font-weight: bold; background: #fdedec; padding: 10px; border-radius: 4px; display: block;}
        .feedback-neutral { color: var(--secondary); font-style: italic; display: block; margin-top: 10px; font-size: 0.9rem;}

        /* Modals & Screens */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        #start-screen, #end-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            #game-area { flex-direction: column; }
            #info-panel { width: 100%; height: 35%; border-right: none; border-bottom: 1px solid #ddd; }
            #interaction-panel { width: 100%; height: 65%; }
            .btn-option { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div id="dashboard-container">
        <canvas id="hud"></canvas>
    </div>

    <!-- Spielbereich -->
    <div id="game-area">
        
        <!-- Start Screen -->
        <div id="start-screen">
            <h1>CO₂-Preis: Steuerungsdilemma</h1>
            <h3>Ein Planspiel zur Klimapolitik</h3>
            <p>Schlüpfen Sie in die Rolle der Regierungsarbeitsgruppe (2021–2026).</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0; text-align: left;">
                <strong>Lernziele:</strong>
                <ul>
                    <li>Zielkonflikte der Umweltpolitik ("Magisches Viereck")</li>
                    <li>Unterschied Preissteuerung vs. Mengensteuerung</li>
                    <li>Soziale Ausgleichsmechanismen (z.B. Klimageld)</li>
                </ul>
            </div>
            <button id="btn-start" class="btn">Simulation starten</button>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden">
            <h1 id="end-title">Simulation beendet</h1>
            <p id="end-reason"></p>
            <div id="end-stats" style="margin: 20px 0;"></div>
            <div style="background:#eee; padding:15px; border-radius:6px; max-width:600px; font-size: 0.85rem;">
                <strong>Datenschutz-Hinweis:</strong><br>
                Dieses Spiel läuft zu 100% lokal im Browser. Es werden keine Daten an Server gesendet. 
                Das Protokoll enthält keine personenbezogenen Daten.
            </div>
            <div style="margin-top:20px;">
                <button id="btn-download" class="btn">Protokoll speichern (.txt)</button>
                <button id="btn-restart" class="btn">Neustart</button>
            </div>
        </div>

        <!-- Info Panel -->
        <div id="info-panel">
            <h2 id="level-title">Lade...</h2>
            <div id="level-text-container"></div>
        </div>

        <!-- Interaction Panel -->
        <div id="interaction-panel">
            <!-- Aufgaben Container -->
            <div id="task-container" style="width: 100%; text-align: center;"></div>
            
            <!-- Entscheidungs Container -->
            <div id="decision-container" class="hidden" style="width: 100%; margin-top: 20px;">
                <h3>Politische Entscheidung</h3>
                <p id="decision-prompt"></p>
                <div id="decision-options"></div>
            </div>

            <!-- Feedback Area (ersetzt Alert) -->
            <div id="feedback-area"></div>
            
            <button id="btn-next" class="btn hidden" style="margin-top: 20px;">Nächstes Level</button>
        </div>
    </div>

    <!-- Modal für Ereignisse -->
    <div id="modal-overlay" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Ereignis</h2>
            <div id="modal-body"></div>
            <button id="btn-modal-close" class="btn">Weiter</button>
        </div>
    </div>

    <script>
        /**
         * 1. KONFIGURATION & DATEN (Model)
         * Datenhaltung getrennt von Logik.
         * level.text enthält erlaubte <b> Tags für Hervorhebungen.
         */
        const GAME_CONFIG = {
            startIndices: {
                emission: 100,
                social: 80,
                economy: 80,
                acceptance: 70
            },
            failThreshold: 20, // Game Over bei < 20
            eventChance: 0.3,   // 30% Chance
            // Whitelist für erlaubte HTML-Tags im Text-Parser
            allowedTags: ['b']
        };

        const LEVEL_DATA = [
            {
                id: 1,
                year: 2021,
                title: "Start 2021 – Einführung BEHG",
                text: "Deutschland führt einen nationalen CO₂-Preis (nEHS) für die Bereiche <b>Wärme und Verkehr</b> ein. Startpreis: 25 €/t CO₂. Dies verteuert fossile Brennstoffe, um Anreize für klimafreundliche Technologien zu setzen. Die erste Kommunikation ist entscheidend.",
                taskType: "QUIZ",
                task: {
                    question: "Welche Sektoren deckt der neue nationale Emissionshandel (nEHS) primär ab?",
                    options: [
                        { id: "q1_a", text: "Schwerindustrie & Energieerzeugung", correct: false },
                        { id: "q1_b", text: "Wärme (Gebäude) & Verkehr", correct: true },
                        { id: "q1_c", text: "Landwirtschaft & Forsten", correct: false }
                    ],
                    feedback: "Korrekt. Industrie & Energie sind bereits im EU-ETS geregelt."
                },
                decision: {
                    prompt: "Wählen Sie eine Kommunikationsstrategie (Framing):",
                    options: [
                        { id: "d1_a", text: "Klimaschutz betonen ('Wir müssen handeln!')", effect: { social: 0, economy: -2, acceptance: -5 }, feedback: "Ehrlich, aber 'Kostenangst' senkt die Akzeptanz." },
                        { id: "d1_b", text: "Entlastung betonen ('Klimageld kommt')", effect: { social: +5, acceptance: +5 }, feedback: "Erhöht die Akzeptanz durch soziale Balance." },
                        { id: "d1_c", text: "Technologie betonen ('Innovation')", effect: { social: -2, economy: +5 }, feedback: "Wirtschaft freut sich, soziale Aspekte fehlen." }
                    ]
                }
            },
            {
                id: 2,
                year: 2022,
                title: "Wer zahlt? (Inzidenz)",
                text: "Das System funktioniert 'upstream'. Nicht Bürger kaufen Zertifikate, sondern <b>Inverkehrbringer</b> (z.B. Raffinerien). Diese geben Kosten an Verbraucher weiter (Überwälzung).",
                taskType: "QUIZ",
                task: {
                    question: "Wer ist gesetzlich verpflichtet, Zertifikate zu erwerben?",
                    options: [
                        { id: "q2_a", text: "Jeder Haushalt", correct: false },
                        { id: "q2_b", text: "Tankstellenbetreiber", correct: false },
                        { id: "q2_c", text: "Inverkehrbringer (Importeure/Händler)", correct: true }
                    ],
                    feedback: "Richtig. Die Kosten landen aber indirekt beim Endkunden."
                },
                decision: {
                    prompt: "Umgang mit steigenden Preisen an der Zapfsäule:",
                    options: [
                        { id: "d2_a", text: "Versteckte Weitergabe tolerieren", effect: { social: -2, acceptance: +2 }, feedback: "Vermeidet Preisschock-Wahrnehmung, mindert aber Lenkungswirkung (Emissionen ±0)." },
                        { id: "d2_b", text: "Transparente Ausweisung fordern", effect: { emission: -2, social: -2, acceptance: -5 }, feedback: "Hohe Lenkungswirkung durch 'Preissignal', aber auch hoher Unmut." }
                    ]
                }
            },
            {
                id: 3,
                year: 2023,
                title: "Zielpfade & Gesetze",
                text: "Das Klimaschutzgesetz (KSG) gibt verbindliche Sektorziele vor. Politische Ziele (z.B. Koalitionsvertrag) gehen oft darüber hinaus, sind aber rechtlich anders zu bewerten.",
                taskType: "DRAG_DROP",
                task: {
                    instruction: "Ordnen Sie die Ziele zu (Gesetzlich vs. Politisch/Langfristig).",
                    buckets: ["2030 (Gesetz)", "2045 (Langfristig)"],
                    items: [
                        { id: "dd3_1", text: "-65% Emissionen", bucket: "2030 (Gesetz)" },
                        { id: "dd3_2", text: "Klimaneutralität", bucket: "2045 (Langfristig)" },
                        { id: "dd3_3", text: "Sektorziel Verkehr", bucket: "2030 (Gesetz)" },
                        { id: "dd3_4", text: "Netto-Null", bucket: "2045 (Langfristig)" }
                    ]
                },
                decision: {
                    prompt: "Verkehrssektor verfehlt Ziele drastisch. Reaktion?",
                    options: [
                        { id: "d3_a", text: "Sofortprogramm (Tempolimit etc.)", effect: { emission: -10, acceptance: -10, social: -5 }, feedback: "Effektiv für Klima, politisch hochriskant." },
                        { id: "d3_b", text: "Ziele verrechnen (Sektorenkopplung)", effect: { emission: +5, acceptance: +2 }, feedback: "Verschiebt das Problem, verringert Transformationsdruck." }
                    ]
                }
            },
            {
                id: 4,
                year: 2024,
                title: "EU-ETS vs. Nationaler ETS",
                text: "Industrie im EU-ETS fürchtet Doppelbelastung oder Wettbewerbsnachteile ('Carbon Leakage'), wenn nationale Preise zusätzlich wirken.",
                taskType: "DRAG_DROP",
                task: {
                    instruction: "Welcher Sektor gehört in welches System?",
                    buckets: ["EU-ETS", "nEHS (National)"],
                    items: [
                        { id: "dd4_1", text: "Kohlekraftwerk", bucket: "EU-ETS" },
                        { id: "dd4_2", text: "Privat-PKW", bucket: "nEHS (National)" },
                        { id: "dd4_3", text: "Gasheizung", bucket: "nEHS (National)" },
                        { id: "dd4_4", text: "Stahlwerk", bucket: "EU-ETS" }
                    ]
                },
                decision: {
                    prompt: "Industrie fordert Strompreisentlastung. Was tun?",
                    options: [
                        { id: "d4_a", text: "Stromsteuer senken", effect: { emission: +2, economy: +8, acceptance: +5 }, feedback: "Entlastet Wirtschaft und Bürger (Sektorenkopplung), senkt Einnahmen." },
                        { id: "d4_b", text: "Keine Ausnahmen", effect: { emission: -5, economy: -8, acceptance: -2 }, feedback: "Hartes Preissignal, Gefahr von Abwanderung." }
                    ]
                }
            },
            {
                id: 5,
                year: 2025,
                title: "Preiskorridor & Markt",
                text: "Der Festpreis endet. Ab 2026 soll ein Preiskorridor gelten, bevor perspektivisch die Mengensteuerung (freier Markt für Zertifikate) übernimmt.",
                taskType: "SLIDER",
                task: {
                    prompt: "Einstiegspreis 2026 festlegen (Korridor-Start):",
                    min: 55,
                    max: 85,
                    labels: ["55€ (Moderat)", "85€ (Ambitioniert)"]
                },
                decision: {
                    type: "SLIDER_LOGIC"
                }
            },
            {
                id: 6,
                year: 2026,
                title: "Sozialer Ausgleich",
                text: "CO₂-Bepreisung wirkt regressiv. Ein Rückverteilungsmechanismus ist für die langfristige Akzeptanz unabdingbar.",
                taskType: "POLICY_BUILDER",
                task: {
                    instruction: "Wählen Sie genau 2 Bausteine für Ihr Paket.",
                    options: [
                        { id: "pb_1", text: "Klimageld (Pro-Kopf)", type: "social" },
                        { id: "pb_2", text: "Pendlerpauschale hoch", type: "mixed" },
                        { id: "pb_3", text: "Ladesäulen-Ausbau", type: "econ" },
                        { id: "pb_4", text: "Vermieter-Beteiligung", type: "social" }
                    ]
                },
                decision: {
                    type: "PACKAGE_LOGIC"
                }
            }
        ];

        const RANDOM_EVENTS = [
            { title: "Gutachten veröffentlicht", text: "Experten kritisieren das Tempo.", effect: { acceptance: -5 } },
            { title: "Proteste", text: "Bürger gehen gegen Energiepreise auf die Straße.", effect: { social: -5, acceptance: -10 } },
            { title: "Tech-Durchbruch", text: "Wärmepumpen werden günstiger.", effect: { acceptance: +5, emission: -5 } },
            { title: "Standort-Debatte", text: "Verband warnt vor Deindustrialisierung.", effect: { economy: -5 } }
        ];

        /**
         * 2. STATE MANAGEMENT
         */
        const state = {
            currentLevelIndex: 0,
            indices: { ...GAME_CONFIG.startIndices },
            score: 0,
            history: [], // Speichert nur IDs/Codes (Datensparsamkeit)
            previewEffects: null,
            locked: false, // WICHTIG: Verhindert Race Conditions / Spam-Klicks
            stepCounter: 0 // Ersatz für Zeitstempel
        };

        /**
         * 3. DOM ELEMENT REFERENZEN
         */
        const DOM = {
            hud: document.getElementById('hud'),
            startScreen: document.getElementById('start-screen'),
            endScreen: document.getElementById('end-screen'),
            gameArea: document.getElementById('game-area'),
            levelTitle: document.getElementById('level-title'),
            levelTextContainer: document.getElementById('level-text-container'),
            taskContainer: document.getElementById('task-container'),
            decisionContainer: document.getElementById('decision-container'),
            decisionPrompt: document.getElementById('decision-prompt'),
            decisionOptions: document.getElementById('decision-options'),
            feedbackArea: document.getElementById('feedback-area'),
            btnNext: document.getElementById('btn-next'),
            modal: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            btnModalClose: document.getElementById('btn-modal-close'),
            btnStart: document.getElementById('btn-start'),
            btnDownload: document.getElementById('btn-download'),
            btnRestart: document.getElementById('btn-restart'),
            endTitle: document.getElementById('end-title'),
            endReason: document.getElementById('end-reason'),
            endStats: document.getElementById('end-stats')
        };

        /**
         * 4. SICHERHEITS-HELPER (XSS-Schutz)
         */
        
        // Ersatz für innerHTML. Erlaubt nur <b> Tags.
        function renderSafeText(container, text) {
            container.textContent = ''; // Clear previous content
            
            // Regex splittet bei <b>...</b>
            // Capture Group () sorgt dafür, dass die Tags im Array bleiben
            const parts = text.split(/(<b>.*?<\/b>)/g);

            parts.forEach(part => {
                if (part.startsWith('<b>') && part.endsWith('</b>')) {
                    const b = document.createElement('b');
                    b.textContent = part.slice(3, -4); // Tags entfernen
                    container.appendChild(b);
                } else if (part.length > 0) {
                    container.appendChild(document.createTextNode(part));
                }
            });
        }

        // Zeigt Feedback im UI statt per Alert
        function showFeedback(msg, type = 'neutral') {
            DOM.feedbackArea.innerHTML = '';
            const el = document.createElement('div');
            el.textContent = msg;
            
            if (type === 'positive') el.className = 'feedback-positive';
            else if (type === 'negative') el.className = 'feedback-negative';
            else el.className = 'feedback-neutral';
            
            DOM.feedbackArea.appendChild(el);
        }

        /**
         * 5. CONTROLLER & LOGIK
         */

        function init() {
            // Event Listener registrieren
            DOM.btnStart.addEventListener('click', startGame);
            DOM.btnNext.addEventListener('click', nextLevel);
            DOM.btnModalClose.addEventListener('click', closeModal);
            DOM.btnDownload.addEventListener('click', downloadLog);
            DOM.btnRestart.addEventListener('click', () => location.reload());

            // Canvas Resizing stabilisieren
            const resizeObserver = new ResizeObserver(() => drawHUD());
            resizeObserver.observe(document.getElementById('dashboard-container'));
            
            drawHUD();
        }

        function startGame() {
            DOM.startScreen.classList.add('hidden');
            loadLevel(0);
        }

        function loadLevel(index) {
            // Fail State Check
            if (state.indices.social < GAME_CONFIG.failThreshold || state.indices.acceptance < GAME_CONFIG.failThreshold) {
                endGame(false, "Die soziale Ungleichheit oder der Widerstand ist zu groß. Regierung gescheitert.");
                return;
            }

            // Win State Check
            if (index >= LEVEL_DATA.length) {
                endGame(true);
                return;
            }

            // State Reset für neues Level
            state.currentLevelIndex = index;
            state.locked = false; 
            state.previewEffects = null;
            
            const level = LEVEL_DATA[index];

            // UI Reset
            DOM.levelTitle.textContent = `Level ${index + 1} (${level.year}): ${level.title}`;
            renderSafeText(DOM.levelTextContainer, level.text); // Safe Rendering
            
            DOM.taskContainer.textContent = ''; // Clear content safe
            DOM.decisionContainer.classList.add('hidden');
            DOM.feedbackArea.textContent = '';
            DOM.btnNext.classList.add('hidden');
            
            // Random Event trigger (30%)
            if (Math.random() < GAME_CONFIG.eventChance) triggerEvent();

            // Render Task
            renderTask(level);
            drawHUD();
        }

        function renderTask(level) {
            const container = DOM.taskContainer;

            if (level.taskType === "QUIZ") {
                const h3 = document.createElement('h3');
                h3.textContent = "Wissens-Check";
                const p = document.createElement('p');
                p.textContent = level.task.question;
                
                container.appendChild(h3);
                container.appendChild(p);

                level.task.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-option';
                    btn.textContent = opt.text;
                    btn.addEventListener('click', () => handleQuizAnswer(opt, level));
                    container.appendChild(btn);
                });
            } 
            else if (level.taskType === "DRAG_DROP") {
                const h3 = document.createElement('h3');
                h3.textContent = "Zuordnung";
                const p = document.createElement('p');
                p.textContent = level.task.instruction;
                container.appendChild(h3);
                container.appendChild(p);

                const dndWrap = document.createElement('div');
                dndWrap.className = 'dnd-container';
                
                // Buckets
                level.task.buckets.forEach(bName => {
                    const bucket = document.createElement('div');
                    bucket.className = 'drop-zone';
                    bucket.dataset.bucket = bName;
                    
                    const header = document.createElement('h4');
                    header.textContent = bName;
                    bucket.appendChild(header);

                    // Drag Events
                    bucket.addEventListener('dragover', e => { e.preventDefault(); bucket.classList.add('drag-over'); });
                    bucket.addEventListener('dragleave', () => bucket.classList.remove('drag-over'));
                    bucket.addEventListener('drop', e => handleDrop(e, bucket, level));
                    
                    dndWrap.appendChild(bucket);
                });
                container.appendChild(dndWrap);

                // Items
                const itemContainer = document.createElement('div');
                itemContainer.id = 'dnd-items';
                
                level.task.items.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'draggable';
                    span.textContent = item.text;
                    span.draggable = true;
                    span.dataset.id = item.id;
                    span.dataset.bucket = item.bucket; // Lösung speichern
                    
                    span.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', JSON.stringify({id: item.id}));
                    });
                    
                    itemContainer.appendChild(span);
                });
                container.appendChild(itemContainer);

                const checkBtn = document.createElement('button');
                checkBtn.id = 'btn-dnd-check'; // ID für gezielten Zugriff
                checkBtn.className = 'btn';
                checkBtn.textContent = 'Prüfen';
                checkBtn.style.marginTop = '15px';
                checkBtn.addEventListener('click', () => evaluateDragDrop(level));
                container.appendChild(checkBtn);
            }
            else if (level.taskType === "SLIDER") {
                const h3 = document.createElement('h3');
                h3.textContent = "Preissetzung";
                const p = document.createElement('p');
                p.textContent = level.task.prompt;
                container.appendChild(h3);
                container.appendChild(p);

                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'slider-container';
                
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = level.task.min;
                slider.max = level.task.max;
                slider.value = level.task.min;
                slider.step = 5;
                
                const valDisplay = document.createElement('p');
                valDisplay.textContent = `Wahl: ${slider.value} €`;

                // Live Preview
                slider.addEventListener('input', (e) => {
                    valDisplay.textContent = `Wahl: ${e.target.value} €`;
                    previewSliderEffect(parseInt(e.target.value));
                });

                sliderDiv.appendChild(slider);
                sliderDiv.appendChild(valDisplay);
                container.appendChild(sliderDiv);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn';
                confirmBtn.textContent = 'Bestätigen';
                confirmBtn.addEventListener('click', () => handleSliderDecision(parseInt(slider.value)));
                container.appendChild(confirmBtn);
            }
            else if (level.taskType === "POLICY_BUILDER") {
                const h3 = document.createElement('h3');
                h3.textContent = "Politik-Paket";
                container.appendChild(h3);
                
                const optsDiv = document.createElement('div');
                level.task.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-option';
                    btn.textContent = opt.text;
                    btn.dataset.id = opt.id;
                    btn.addEventListener('click', () => {
                        if (state.locked) return;
                        btn.classList.toggle('selected');
                        previewPackageEffect();
                    });
                    optsDiv.appendChild(btn);
                });
                container.appendChild(optsDiv);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn';
                confirmBtn.textContent = 'Paket verabschieden';
                confirmBtn.addEventListener('click', handlePackageDecision);
                container.appendChild(confirmBtn);
            }
        }

        /* --- Logik Handler --- */

        function handleQuizAnswer(option, level) {
            // Locking Check
            if (state.locked) return;
            state.locked = true;

            const allBtns = DOM.taskContainer.querySelectorAll('.btn-option');
            allBtns.forEach(b => b.disabled = true);

            if (option.correct) {
                showFeedback(`Richtig! ${level.task.feedback}`, 'positive');
                state.score += 20;
                showDecisionPhase(level);
            } else {
                showFeedback("Falsch. Versuch es nochmal.", 'negative');
                state.score = Math.max(0, state.score - 5);
                state.locked = false; // Entsperren für neuen Versuch
                allBtns.forEach(b => b.disabled = false);
            }
        }

        function handleDrop(e, targetZone, level) {
            e.preventDefault();
            targetZone.classList.remove('drag-over');
            
            const dataStr = e.dataTransfer.getData('text/plain');
            if (!dataStr) return;
            
            try {
                const data = JSON.parse(dataStr);
                
                // Validierung: Gehört die ID zu diesem Level?
                const validItem = level.task.items.find(i => i.id === data.id);
                if (!validItem) throw new Error("Invalid Item ID");

                // Element sicher selektieren
                const el = document.querySelector(`.draggable[data-id="${data.id}"]`);
                if (el && targetZone) {
                    targetZone.appendChild(el);
                }
            } catch (err) {
                console.warn("Ungültige Drop-Daten ignoriert.");
            }
        }

        function evaluateDragDrop(level) {
            if (state.locked) return;

            const zones = document.querySelectorAll('.drop-zone');
            let allCorrect = true;
            let itemsProcessed = 0;

            // Zähle Elemente
            const totalItems = level.task.items.length;
            const droppedItems = document.querySelectorAll('.drop-zone .draggable').length;

            if (droppedItems < totalItems) {
                showFeedback("Bitte alle Elemente zuordnen!", 'neutral');
                return;
            }

            // Auswertung
            zones.forEach(zone => {
                const zoneBucket = zone.dataset.bucket;
                const items = zone.querySelectorAll('.draggable');
                
                items.forEach(item => {
                    if (item.dataset.bucket === zoneBucket) {
                        item.classList.add('correct');
                        state.score += 10;
                    } else {
                        item.classList.add('wrong');
                        allCorrect = false;
                        state.score = Math.max(0, state.score - 5);
                    }
                    item.draggable = false;
                });
            });

            state.locked = true;
            const checkBtn = document.getElementById('btn-dnd-check');
            if(checkBtn) checkBtn.disabled = true;

            showDecisionPhase(level);
        }

        function previewSliderEffect(val) {
            const intensity = (val - 55) / 30; 
            state.previewEffects = {
                emission: -10 - (intensity * 20),
                social: -5 - (intensity * 15),
                economy: -5 - (intensity * 10),
                acceptance: -5 - (intensity * 20)
            };
            drawHUD();
        }

        function handleSliderDecision(val) {
            if (state.locked) return;
            state.locked = true;

            previewSliderEffect(val); // Final calc
            applyEffects(state.previewEffects);
            state.previewEffects = null;
            
            logStep(`SLIDER_VAL:${val}`);
            
            // Text-Feedback sicher einfügen
            DOM.taskContainer.textContent = '';
            const p = document.createElement('p');
            p.textContent = `Entscheidung: Preiskorridor startet bei ${val} €.`;
            DOM.taskContainer.appendChild(p);
            
            DOM.btnNext.classList.remove('hidden');
        }

        function previewPackageEffect() {
            const selected = document.querySelectorAll('.selected');
            let effects = { emission: 0, social: 0, economy: 0, acceptance: 0 };
            
            selected.forEach(el => {
                const id = el.dataset.id;
                // Logik-Mapping (Hardcoded für Sicherheit)
                if (id === 'pb_1') { effects.social += 20; effects.acceptance += 15; effects.economy += 5; }
                else if (id === 'pb_2') { effects.social += 10; effects.emission += 5; effects.acceptance += 5; }
                else if (id === 'pb_3') { effects.emission -= 10; effects.economy += 10; }
                else if (id === 'pb_4') { effects.social += 10; effects.acceptance -= 5; }
            });
            state.previewEffects = effects;
            drawHUD();
        }

        function handlePackageDecision() {
            if (state.locked) return;

            const selected = document.querySelectorAll('.selected');
            if (selected.length !== 2) {
                showFeedback("Bitte genau 2 Maßnahmen wählen.", 'neutral');
                return;
            }
            
            state.locked = true;
            previewPackageEffect(); 
            applyEffects(state.previewEffects);
            state.previewEffects = null;
            
            const ids = Array.from(selected).map(el => el.dataset.id);
            logStep(`PACKAGE:${ids.join('+')}`);
            
            DOM.taskContainer.innerHTML = ''; // Clear
            const p = document.createElement('p');
            p.textContent = 'Paket verabschiedet.';
            DOM.taskContainer.appendChild(p);

            DOM.btnNext.classList.remove('hidden');
        }

        function showDecisionPhase(level) {
            if (!level.decision || !level.decision.options) {
                DOM.btnNext.classList.remove('hidden');
                return;
            }

            state.locked = false; // Unlock for decision phase
            DOM.decisionContainer.classList.remove('hidden');
            DOM.decisionPrompt.textContent = level.decision.prompt;
            DOM.decisionOptions.textContent = ''; // Clear

            level.decision.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-option';
                btn.textContent = opt.text;
                
                // Preview Logic
                btn.addEventListener('mouseenter', () => {
                    if (state.locked) return;
                    state.previewEffects = opt.effect;
                    drawHUD();
                });
                btn.addEventListener('mouseleave', () => {
                    if (state.locked) return;
                    state.previewEffects = null;
                    drawHUD();
                });

                // Decision Handler
                btn.addEventListener('click', () => {
                    if (state.locked) return;
                    state.locked = true; // Lock immediately

                    state.previewEffects = null;
                    applyEffects(opt.effect);
                    logStep(`DECISION:${opt.id}`);
                    
                    // UI Update safe
                    DOM.decisionOptions.textContent = ''; 
                    
                    const p = document.createElement('p');
                    const b = document.createElement('b');
                    b.textContent = opt.text;
                    p.appendChild(document.createTextNode('Gewählt: '));
                    p.appendChild(b);
                    
                    const fb = document.createElement('p');
                    fb.className = 'feedback-neutral';
                    fb.textContent = opt.feedback;
                    
                    DOM.decisionContainer.appendChild(p);
                    DOM.decisionContainer.appendChild(fb);
                    DOM.btnNext.classList.remove('hidden');
                });

                DOM.decisionOptions.appendChild(btn);
            });
        }

        function applyEffects(effects) {
            if (!effects) return;
            for (let key in effects) {
                if (state.indices.hasOwnProperty(key)) {
                    state.indices[key] = Math.max(0, Math.min(100, state.indices[key] + effects[key]));
                }
            }
            drawHUD();
        }

        function triggerEvent() {
            const ev = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
            applyEffects(ev.effect);
            
            DOM.modalTitle.textContent = ev.title;
            DOM.modalBody.textContent = ev.text;
            DOM.modal.style.display = 'flex';
            
            logStep(`EVENT:${ev.title}`);
        }

        function closeModal() {
            DOM.modal.style.display = 'none';
        }

        function nextLevel() {
            loadLevel(state.currentLevelIndex + 1);
        }

        // DSGVO: Nur Step-ID speichern, keine Zeitstempel
        function logStep(actionCode) {
            state.stepCounter++;
            state.history.push(`${state.stepCounter}:${actionCode}`);
        }

        /* --- Rendering (Canvas) --- */

        function drawHUD() {
            const ctx = DOM.hud.getContext('2d');
            
            // High DPI Scaling & Size Clamping
            const dpr = window.devicePixelRatio || 1;
            const rect = DOM.hud.getBoundingClientRect();
            // Prevent negative width on tiny screens
            const width = Math.max(10, rect.width);
            const height = Math.max(10, rect.height);
            
            DOM.hud.width = width * dpr;
            DOM.hud.height = height * dpr;
            
            // Transform Reset (Stabilität)
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);

            ctx.clearRect(0, 0, width, height);
            ctx.font = "bold 12px Segoe UI";

            const metrics = [
                { key: 'emission', label: "Emissionen", color: "#2ecc71", invert: true }, 
                { key: 'social', label: "Sozial", color: "#3498db" },
                { key: 'economy', label: "Wirtschaft", color: "#f1c40f" },
                { key: 'acceptance', label: "Akzeptanz", color: "#9b59b6" }
            ];

            const barWidth = Math.max(10, (width - 40) / 4); 
            let x = 10;

            metrics.forEach(m => {
                const val = state.indices[m.key];
                let previewDelta = 0;
                
                // Safe Check for 0 value
                if (state.previewEffects && state.previewEffects[m.key] !== undefined) {
                    previewDelta = state.previewEffects[m.key];
                }

                // Label
                ctx.fillStyle = "#333";
                ctx.fillText(m.label, x, 15);

                // Wert Text
                let valStr = Math.round(val) + "%";
                if (previewDelta !== 0) {
                    const sign = previewDelta > 0 ? "+" : "";
                    valStr += ` (${sign}${Math.round(previewDelta)})`;
                }
                ctx.fillText(valStr, x, 75);

                // Hintergrund
                ctx.fillStyle = "#ecf0f1";
                ctx.fillRect(x, 25, barWidth - 10, 30);

                // Füllung
                let barColor = m.color;
                if (m.invert && val > 80) barColor = "#e74c3c"; 
                if (!m.invert && val < 30) barColor = "#e74c3c";

                ctx.fillStyle = barColor;
                // Clamp width to prevent negative rects
                const fillW = Math.max(0, (val / 100) * (barWidth - 10));
                ctx.fillRect(x, 25, fillW, 30);

                // Preview Overlay
                if (previewDelta !== 0) {
                    const newVal = Math.max(0, Math.min(100, val + previewDelta));
                    const newW = Math.max(0, (newVal / 100) * (barWidth - 10));
                    
                    if (previewDelta > 0) {
                        ctx.fillStyle = "rgba(46, 204, 113, 0.5)"; 
                        ctx.fillRect(x + fillW, 25, Math.max(0, newW - fillW), 30);
                    } else {
                        ctx.fillStyle = "rgba(231, 76, 60, 0.6)"; 
                        ctx.fillRect(x + newW, 25, Math.max(0, fillW - newW), 30);
                    }
                }

                x += barWidth;
            });
        }

        /* --- Spielende --- */

        function endGame(success, reason) {
            DOM.gameArea.textContent = ''; // Clear safe
            DOM.gameArea.appendChild(DOM.endScreen);
            DOM.endScreen.classList.remove('hidden');
            DOM.endScreen.style.display = 'flex';

            const emissionGoal = state.indices.emission <= 50;
            
            if (success) {
                let rating = "Ausbaufähig";
                if (emissionGoal && state.indices.social > 60) rating = "Exzellent (Nachhaltig)";
                else if (emissionGoal) rating = "Gut (Klimaziel erreicht)";
                else rating = "Ziel verfehlt (Emissionen zu hoch)";

                DOM.endTitle.textContent = "Simulation abgeschlossen (2026)";
                DOM.endTitle.style.color = "var(--accent)";
                
                // Safe HTML construction
                DOM.endReason.textContent = '';
                DOM.endReason.appendChild(document.createTextNode('Politik-Bewertung: '));
                const b = document.createElement('b');
                b.textContent = rating;
                DOM.endReason.appendChild(b);

            } else {
                DOM.endTitle.textContent = "Regierung gescheitert";
                DOM.endTitle.style.color = "var(--danger)";
                DOM.endReason.textContent = reason;
            }

            // Stats safe rendering
            DOM.endStats.innerHTML = ''; // reset
            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.padding = '0';
            
            const stats = [
                `Emissionen: ${state.indices.emission}%`,
                `Sozialindex: ${state.indices.social}%`,
                `Akzeptanz: ${state.indices.acceptance}%`
            ];
            
            stats.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                ul.appendChild(li);
            });
            DOM.endStats.appendChild(ul);
        }

        function downloadLog() {
            // Metadaten minimal
            const header = "CO2-Dilemma Game Log\n";
            const stats = `Final: E:${state.indices.emission} S:${state.indices.social} Ec:${state.indices.economy} A:${state.indices.acceptance}\n`;
            const content = state.history.join('\n');
            
            const blob = new Blob([header + stats + "\n--- STEPS ---\n" + content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GameLog.txt`; // Kein Zeitstempel im Dateinamen
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Starten
        init();

    </script>
</body>
</html>
