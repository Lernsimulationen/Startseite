<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das Lohn-Dilemma: Simulation nach M11-M13</title>
    <!-- 
      SICHERHEITSHINWEIS FÜR LEHRKRÄFTE:
      1. DSGVO: Es werden keine Daten an externe Server gesendet. Alles läuft lokal im Browser.
      2. XSS-Schutz: Wir nutzen kein 'innerHTML' für Benutzereingaben, sondern nur sichere Text-Knoten.
      3. Robustheit: Eingaben werden validiert ("Gegen-Trolling"). 
      4. Responsiv: Optimiert für Google Sites Einbettung (iframe) und Smartphones.
    -->
    <style>
        /* --- Styles bleiben lokal (DSGVO-konform) --- */
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-slate-50: #f8fafc;
            --bg-slate-100: #f1f5f9;
            --bg-slate-200: #e2e8f0;
            --bg-slate-800: #1e293b;
            --bg-slate-900: #0f172a;
            
            --text-slate-400: #94a3b8;
            --text-slate-500: #64748b;
            --text-slate-600: #475569;
            --text-slate-700: #334155;
            --text-slate-800: #1e293b;
            --text-slate-900: #0f172a;
            --text-white: #ffffff;

            --color-blue-100: #dbeafe;
            --color-blue-500: #3b82f6;
            --color-blue-600: #2563eb;

            --color-red-100: #fee2e2;
            --color-red-400: #f87171;
            --color-red-500: #ef4444;
            --color-red-600: #dc2626;
            --color-red-800: #991b1b;

            --color-green-50: #f0fdf4;
            --color-green-400: #4ade80;
            --color-green-500: #22c55e;
            --color-green-700: #15803d;

            --color-yellow-50: #fefce8;
            --color-yellow-100: #fef9c3;
            --color-yellow-500: #eab308;

            --color-indigo-500: #6366f1;
            --color-amber-500: #f59e0b;

            /* System Fonts für maximalen Datenschutz (keine Google Fonts Requests) */
            --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-serif: Georgia, Cambria, "Times New Roman", Times, serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-body);
            color: var(--text-slate-800);
            margin: 0;
            /* Responsives Padding: Minimum 0.5rem, Ziel 3vw, Max 1rem */
            padding: clamp(0.5rem, 3vw, 1rem); 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh; /* Mindesthöhe, aber dehnbar */
        }

        /* --- UI Komponenten --- */
        .btn-primary {
            background-color: var(--bg-slate-900);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.125rem;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary:hover { background-color: var(--bg-slate-800); }
        .btn-primary:active { transform: scale(0.98); }

        .btn-start {
            background-color: var(--color-blue-600);
            color: white;
            padding: clamp(0.75rem, 2vw, 1rem) clamp(1.5rem, 4vw, 2.5rem);
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            font-size: clamp(1rem, 2.5vw, 1.125rem);
        }
        .btn-start:hover { transform: translateY(-2px); }

        .card-white {
            background-color: var(--bg-card);
            border: 1px solid var(--bg-slate-200);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .input-calc {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--bg-slate-200);
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            color: var(--text-slate-800);
            margin-top: 0.5rem;
        }
        .input-calc:focus {
            outline: none;
            border-color: var(--color-blue-500);
        }

        /* --- Layout Grid (Responsive Update) --- */
        .main-grid {
            display: flex;
            flex-direction: column; /* Default: Mobile Stack */
            background: var(--bg-card);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 64rem;
        }

        @media (min-width: 768px) {
            .main-grid { 
                display: grid;
                grid-template-columns: repeat(12, 1fr); 
            }
            .sidebar { grid-column: span 4; }
            .content-area { grid-column: span 8; }
            .hidden-md { display: none !important; }
            /* Auf Desktop Button verstecken */
            #sidebar-toggle { display: none !important; }
            /* Auf Desktop Inhalt immer zeigen */
            #sidebar-content { display: flex !important; }
        }

        .sidebar {
            background-color: var(--bg-slate-50);
            border-right: 1px solid var(--bg-slate-200);
            padding: clamp(1rem, 2vw, 1.5rem);
        }
        
        .content-area { 
            padding: clamp(1rem, 2vw, 1.5rem); 
        }

        /* Sidebar Mobile Toggle Styling */
        #sidebar-toggle {
            display: block;
            width: 100%;
            background: var(--bg-slate-200);
            color: var(--text-slate-700);
            border: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: left;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        #sidebar-content {
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
        }
        /* Klasse zum Verstecken des Sidebar-Inhalts auf Mobile */
        .collapsed-mobile {
            display: none !important;
        }

        /* --- Stats Bars --- */
        .scale-bar-container {
            height: 24px;
            background: var(--bg-slate-200);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .scale-fill { height: 100%; transition: width 0.5s ease; }

        /* --- Slider --- */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px;
            border-radius: 50%; background: var(--bg-slate-900);
            cursor: pointer; margin-top: -12px;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: var(--bg-slate-200); border-radius: 3px;
        }

        /* --- Tour Overlay --- */
        #tour-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            display: none;
        }
        
        .tour-highlight {
            position: relative;
            z-index: 101;
            background: white;
            box-shadow: 0 0 0 4px var(--color-blue-500), 0 0 30px rgba(0,0,0,0.7);
            border-radius: 0.5rem;
        }

        .tour-tooltip {
            position: fixed;
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            /* Responsive Width */
            width: min(360px, 92vw);
            /* Safety constraints */
            max-height: 70vh;
            overflow-y: auto;
            
            z-index: 102;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
            animation: fadeIn 0.3s;
            left: 50%;
            transform: translateX(-50%);
        }

        .tour-tooltip h3 { margin-top: 0; color: var(--color-blue-600); }
        .tour-btn {
            margin-top: 1rem;
            padding: 0.5rem 1.5rem;
            background: var(--color-blue-600);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- Utils & Modal Robustness --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-4 { gap: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: bold; }
        .text-red-600 { color: var(--color-red-600); }
        .text-green-500 { color: var(--color-green-500); }
        .text-blue-600 { color: var(--color-blue-600); }
        
        /* Modal Scroll Schutz */
        #modal-content-wrapper {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 28rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s;
            /* Wichtig für kleine Screens */
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Kopfzeile -->
    <header style="margin-bottom: 2rem; text-align: center;">
        <h1 style="font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 900; margin-bottom: 0.5rem;">Das Lohn-Dilemma ⚖️</h1>
        <p style="color: var(--text-slate-500); font-size: clamp(0.875rem, 2vw, 1rem);">Lohnpolitik-Simulation (M11-M13)</p>
    </header>

    <!-- Hauptspielbereich -->
    <main id="game-ui" class="main-grid hidden">
        
        <!-- Linke Seitenleiste: Daten & Stats -->
        <aside class="sidebar">
            
            <!-- Mobile Toggle Button -->
            <button id="sidebar-toggle" onclick="toggleSidebar()">
                Anzeigen: Formel & Punktestand &#9660;
            </button>

            <!-- Wrapper für den Inhalt, der ein-/ausgeklappt wird -->
            <div id="sidebar-content" class="collapsed-mobile">
                
                <!-- FORMEL KARTE -->
                <div id="tour-formula">
                    <h3 style="font-size: 0.875rem; color: var(--text-slate-400); text-transform: uppercase; margin-bottom: 0.5rem; font-weight: bold;">Die Formel (M11)</h3>
                    <div class="card-white">
                        <div class="flex justify-between" style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                            <span>Inflation</span>
                            <span class="font-bold text-red-600" id="infl-val">2.0%</span>
                        </div>
                        <div style="width: 100%; background: var(--bg-slate-100); height: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.75rem;">
                            <div style="background: var(--color-red-400); width: 50%; height: 100%; border-radius: 0.25rem;"></div>
                        </div>
                        
                        <div class="text-center" style="color: var(--text-slate-400); font-size: 0.75rem;">+</div>

                        <div class="flex justify-between" style="font-size: 0.875rem; margin-bottom: 0.25rem;">
                            <span>Produktivität</span>
                            <span class="font-bold text-green-500" id="prod-val">1.5%</span>
                        </div>
                        <div style="width: 100%; background: var(--bg-slate-100); height: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.75rem;">
                            <div style="background: var(--color-green-400); width: 40%; height: 100%; border-radius: 0.25rem;"></div>
                        </div>
                        
                        <hr style="border: 0; border-top: 1px solid var(--bg-slate-200); margin: 0.75rem 0;">
                        
                        <!-- EINGABEFELD -->
                        <label for="user-calc-input" style="font-size: 0.75rem; font-weight: bold; color: var(--text-slate-600); display: block;">
                            Berechne den Verteilungsspielraum:
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" id="user-calc-input" class="input-calc" placeholder="?" step="0.1">
                            <span style="font-weight: bold; color: var(--text-slate-600);">%</span>
                        </div>
                        <p id="calc-feedback" style="font-size: 0.75rem; margin-top: 0.25rem; height: 1rem;"></p>
                    </div>
                </div>

                <!-- STATS KARTE -->
                <div id="tour-stats" style="display: flex; flex-direction: column; gap: 1rem;">
                    <h3 style="font-size: 0.875rem; color: var(--text-slate-400); text-transform: uppercase; font-weight: bold;">Dein Punktestand</h3>
                    
                    <div>
                        <div class="flex justify-between" style="font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <span>Frieden (Gewerkschaft)</span>
                            <span id="peace-val">50%</span>
                        </div>
                        <div class="scale-bar-container">
                            <div id="bar-peace" class="scale-fill" style="background: var(--color-indigo-500); width: 50%"></div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between" style="font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <span>Wettbewerb (Arbeitgeber)</span>
                            <span id="comp-val">50%</span>
                        </div>
                        <div class="scale-bar-container">
                            <div id="bar-comp" class="scale-fill" style="background: var(--color-amber-500); width: 50%"></div>
                        </div>
                    </div>

                    <div style="border-top: 1px solid var(--bg-slate-200); padding-top: 0.5rem;">
                        <div class="flex justify-between" style="font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <span title="Risiko für Geringqualifizierte">"Outsider"-Arbeitslose ⚠️</span>
                            <span id="unemp-val" class="font-bold text-red-600">5.0%</span>
                        </div>
                        <div class="scale-bar-container">
                            <div id="bar-unemp" class="scale-fill" style="background: var(--color-red-500); width: 25%"></div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <span style="font-size: 0.75rem; color: var(--text-slate-400); text-transform: uppercase;">Zeit</span>
                        <div id="timer-display" style="font-family: monospace; font-size: 1.25rem; font-weight: bold; color: var(--text-slate-600);">00:00</div>
                    </div>
                </div>
            </div> <!-- End Sidebar Content Wrapper -->
        </aside>

        <!-- Hauptinhalt: Interaktion -->
        <section class="content-area flex flex-col justify-between" style="background: white; position: relative;">
            
            <div class="flex justify-between items-center mb-4">
                <span style="background: var(--bg-slate-900); color: white; padding: 0.5rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: bold;">
                    Runde <span id="round-current">1</span> / 4
                </span>
                <span id="year-label" style="background: var(--bg-slate-100); color: var(--text-slate-600); padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: bold;">
                    Szenario: Normaljahr
                </span>
            </div>

            <!-- Entscheidung 1: Lohn -->
            <div id="tour-wage" class="mb-4">
                <h2 style="font-size: clamp(1.1rem, 3vw, 1.25rem); font-weight: bold; margin-bottom: 1rem; font-family: var(--font-serif);">1. Die Tarifverhandlung</h2>
                <div id="wage-box" style="background: var(--bg-slate-50); padding: clamp(1rem, 2vw, 1.5rem); border-radius: 0.75rem; border: 2px solid var(--bg-slate-200); position: relative;">
                    
                    <label for="wage-input" style="display: block; text-align: center; font-weight: bold; color: var(--text-slate-600); margin-bottom: 1rem;">
                        Lohnerhöhung: <span id="wage-output" style="font-size: 2rem; color: var(--text-slate-900); font-weight: 900;">0.0%</span>
                    </label>
                    
                    <input type="range" id="wage-input" min="0" max="8" step="0.1" value="0.0">
                    
                    <div class="flex justify-between" style="font-size: 0.75rem; color: var(--text-slate-400); margin-top: 0.5rem;">
                        <span>0%</span>
                        <span style="color: var(--color-blue-500); font-weight: bold;">???</span>
                        <span>8%</span>
                    </div>
                </div>
            </div>

            <!-- Entscheidung 2: Mindestlohn -->
            <div id="tour-minwage" class="mb-4" style="padding: 1rem; border: 2px dashed var(--text-slate-400); border-radius: 0.75rem;">
                <div class="flex justify-between items-center" style="gap: 1rem; flex-wrap: wrap;">
                    <div>
                        <h2 style="font-size: clamp(1rem, 2.5vw, 1.125rem); font-weight: bold;">2. Staatlicher Eingriff</h2>
                        <p style="font-size: 0.875rem; color: var(--text-slate-500);">Mindestlohn erhöhen?</p>
                    </div>
                    <button id="min-wage-btn" onclick="toggleMinWage()" style="background: var(--bg-slate-100); border: 1px solid var(--bg-slate-200); padding: 0.75rem; border-radius: 0.5rem; color: var(--text-slate-500); font-weight: bold; transition: all 0.2s;">
                        Nein, Autonomie wahren
                    </button>
                </div>
                <div id="min-wage-info" class="hidden" style="margin-top: 1rem; font-size: 0.75rem; background: var(--color-yellow-50); padding: 0.75rem; border-radius: 0.5rem;">
                    <div style="color: var(--color-green-700); margin-bottom: 0.5rem;"><strong>Pro (M12):</strong> Stärkt Kaufkraft</div>
                    <div style="color: var(--color-red-600);"><strong>Contra (M13):</strong> Belastet Outsider</div>
                </div>
            </div>

            <button onclick="commitRound()" class="btn-primary">Entscheidung verkünden</button>

        </section>
    </main>

    <!-- Start Overlay -->
    <div id="start-overlay" style="position: fixed; inset: 0; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;">
        <div style="max-width: 36rem; text-align: center; margin: auto;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">⚖️</div>
            <h1 style="font-size: clamp(2rem, 5vw, 2.5rem); font-weight: 900; margin-bottom: 1rem;">Das Lohn-Dilemma</h1>
            <p style="color: var(--text-slate-600); margin-bottom: 2rem; line-height: 1.6; font-size: clamp(0.9rem, 2vw, 1rem);">
                Willkommen am Verhandlungstisch.<br>
                Als Schlichter müssen Sie die Lohnforderung (M11) und die Mindestlohn-Debatte (M12/M13) ausbalancieren.
            </p>
            <button onclick="startTour()" class="btn-start">Simulation starten</button>
        </div>
    </div>

    <!-- Tour Overlay -->
    <div id="tour-overlay">
        <div id="tour-tooltip" class="tour-tooltip">
            <h3 id="tour-title">Titel</h3>
            <p id="tour-text" style="color: var(--text-slate-600); font-size: 0.9rem; line-height: 1.5;">Text</p>
            <button id="tour-next-btn" class="tour-btn">Weiter</button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="modal" style="position: fixed; inset: 0; background: rgba(15,23,42,0.6); z-index: 50; display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px);">
        <!-- Wrapper für Scrolling auf kleinen Screens -->
        <div id="modal-content-wrapper">
            <h2 id="modal-title" style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Ergebnis</h2>
            
            <div id="calc-feedback-modal" style="display: none; background: var(--color-red-100); color: var(--color-red-800); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;"></div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem;">
                <!-- Sichere Text-Ausgabe via 'textContent' im JS -->
                <div style="background: var(--bg-slate-50); padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--bg-slate-200);">
                    <div style="font-size: 0.75rem; font-weight: bold; color: var(--text-slate-400); text-transform: uppercase;">Gewerkschaft</div>
                    <div id="res-union" style="font-style: italic; font-size: 0.875rem;">...</div>
                </div>
                <div style="background: var(--bg-slate-50); padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--bg-slate-200);">
                    <div style="font-size: 0.75rem; font-weight: bold; color: var(--text-slate-400); text-transform: uppercase;">Arbeitgeber</div>
                    <div id="res-employer" style="font-style: italic; font-size: 0.875rem;">...</div>
                </div>
                <div style="background: var(--color-red-100); padding: 0.75rem; border-radius: 0.5rem;">
                    <div style="font-size: 0.75rem; font-weight: bold; color: var(--color-red-600); text-transform: uppercase;">Markt</div>
                    <div id="res-market" style="font-size: 0.875rem;">...</div>
                </div>
            </div>

            <button onclick="nextRound()" class="btn-primary">Nächstes Jahr</button>
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" style="display: none; max-width: 64rem; width: 100%; margin-top: 2rem; background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="background: var(--bg-slate-900); color: white; padding: 2rem; text-align: center;">
            <h2 style="font-size: 2rem; font-weight: bold;">Vollständige Dokumentation</h2>
        </div>
        <div style="padding: 2rem;">
            <!-- Sichere DOM-Generierung statt innerHTML -->
            <div id="history-list" style="display: flex; flex-direction: column; gap: 1rem;"></div>
            <div style="margin-top: 2rem; text-align: center;">
                <p id="final-summary" style="font-weight: bold; margin-bottom: 1rem;"></p>
                <button onclick="location.reload()" class="btn-start">Neustart</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * SICHERHEITSKONFIGURATION
         * ENABLE_TIMER_LOG: Aktiviert das Logging der Zeitdauer (Datensparsamkeit).
         * MAX_VAL_CHECK: Grenzwert für Eingaben, um "Trolling" zu verhindern.
         */
        const CONFIG = {
            ENABLE_TIMER_LOG: true, 
            MAX_VAL_CHECK: 50, // Unrealistisch hohe Prozentwerte abfangen
            MIN_VAL_CHECK: -10
        };

        // --- Spielzustand ---
        const state = {
            round: 1,
            maxRounds: 4,
            inflation: 2.0,
            productivity: 1.5,
            
            // Bewertungsindikatoren (0-100 oder %)
            socialPeace: 50,
            competitiveness: 50,
            outsiderUnemployment: 5.0,
            
            // Eingaben & Zeit
            minWageActive: false,
            startTime: 0,
            history: [] // Speichert Ergebnisse
        };

        const scenarios = [
            { name: "Basis-Szenario", infl: 2.0, prod: 1.5 },
            { name: "Hohe Inflation", infl: 4.5, prod: 1.0 },
            { name: "Rezession", infl: 1.5, prod: -0.5 },
            { name: "Ungleichheit", infl: 2.5, prod: 1.5 }
        ];

        // --- DOM-Element Referenzen ---
        const ui = {
            wageInput: document.getElementById('wage-input'),
            wageOutput: document.getElementById('wage-output'),
            userInput: document.getElementById('user-calc-input'),
            feedback: document.getElementById('calc-feedback'),
            minWageBtn: document.getElementById('min-wage-btn'),
            minWageInfo: document.getElementById('min-wage-info'),
            timer: document.getElementById('timer-display')
        };

        let timerInterval;

        // --- SIDEBAR LOGIK (RESPONSIVE) ---
        function toggleSidebar() {
            const content = document.getElementById('sidebar-content');
            const btn = document.getElementById('sidebar-toggle');
            const isCollapsed = content.classList.contains('collapsed-mobile');
            
            if (isCollapsed) {
                content.classList.remove('collapsed-mobile');
                btn.innerHTML = 'Ausblenden: Formel & Punktestand &#9650;'; // Up arrow
            } else {
                content.classList.add('collapsed-mobile');
                btn.innerHTML = 'Anzeigen: Formel & Punktestand &#9660;'; // Down arrow
            }
        }

        // Automatische Anpassung bei Fenstergröße
        window.addEventListener('resize', () => {
            const content = document.getElementById('sidebar-content');
            const btn = document.getElementById('sidebar-toggle');
            
            if (window.innerWidth >= 768) {
                // Auf Desktop immer sichtbar
                content.classList.remove('collapsed-mobile');
            } else {
                // Auf Mobile: Standardmäßig einklappen, wenn nicht schon user-interagiert? 
                // Hier lassen wir den aktuellen Status, oder setzen auf collapsed beim Wechsel.
                // Für Simplicity: lassen wir den User entscheiden, aber stellen sicher, dass Toggle sichtbar ist.
            }
        });

        // --- TOUR SYSTEM ---
        const tourSteps = [
            { 
                id: 'tour-formula', 
                title: 'Wirtschaftsdaten & Formel', 
                text: 'Hier sehen Sie Inflation und Produktivität. Ihre erste Aufgabe: Berechnen Sie die Summe und tragen Sie diese ein. Das ist der "Verteilungsspielraum" (M11).' 
            },
            { 
                id: 'tour-stats', 
                title: 'Zielgrößen', 
                text: 'Behalten Sie diese Werte im Auge. "Outsider-Arbeitslose" reagieren empfindlich auf zu hohe Mindestlöhne (M13).' 
            },
            { 
                id: 'tour-wage', 
                title: 'Der Hebel', 
                text: 'Hier setzen Sie den Tariflohn fest. 0% ist der Startwert. Orientiere dich an deinem berechneten Spielraum!' 
            },
            { 
                id: 'tour-minwage', 
                title: 'Die Politik', 
                text: 'Entscheiden Sie zusätzlich, ob der Staat eingreift. Dies hat starke Auswirkungen auf Geringverdiener (Pro/Contra M12/M13).' 
            }
        ];
        let currentTourStep = 0;

        function startTour() {
            document.getElementById('start-overlay').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            // Check initial state for sidebar on mobile
            if (window.innerWidth < 768) {
                document.getElementById('game-ui').style.display = 'flex'; // Mobile stack
            } else {
                document.getElementById('game-ui').style.display = 'grid'; // Desktop grid
            }
            
            const overlay = document.getElementById('tour-overlay');
            overlay.style.display = 'block';
            
            showTourStep(0);
        }

        function showTourStep(index) {
            // Aufräumen alter Highlights
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            
            if(index >= tourSteps.length) {
                // Tour Ende
                document.getElementById('tour-overlay').style.display = 'none';
                loadRound();
                return;
            }

            const step = tourSteps[index];
            const target = document.getElementById(step.id);
            const tooltip = document.getElementById('tour-tooltip');
            
            // SIDEBAR AUTO-EXPAND LOGIK:
            // Wenn das Ziel in der Sidebar liegt und wir auf Mobile sind -> Aufklappen!
            if (window.innerWidth < 768 && target.closest('#sidebar-content')) {
                const content = document.getElementById('sidebar-content');
                if (content.classList.contains('collapsed-mobile')) {
                    toggleSidebar();
                }
            }

            // Highlight setzen
            target.classList.add('tour-highlight');
            target.scrollIntoView({behavior: 'smooth', block: 'center'});

            // Text setzen via textContent (XSS sicher)
            document.getElementById('tour-title').textContent = step.title;
            document.getElementById('tour-text').textContent = step.text;

            // Intelligente Positionierung (Vermeidet Überlappung)
            const rect = target.getBoundingClientRect();
            const screenHeight = window.innerHeight;
            
            // Wenn Element in der oberen Hälfte -> Tooltip unten, sonst oben
            if (rect.top < screenHeight / 2) {
                tooltip.style.top = 'auto';
                tooltip.style.bottom = '10%';
            } else {
                tooltip.style.bottom = 'auto';
                tooltip.style.top = '10%';
            }

            const btn = document.getElementById('tour-next-btn');
            btn.onclick = () => showTourStep(index + 1);
            btn.textContent = (index === tourSteps.length - 1) ? "Los geht's!" : "Weiter";
        }

        // --- SPIEL LOGIK ---

        function loadRound() {
            const scen = scenarios[state.round - 1];
            state.inflation = scen.infl;
            state.productivity = scen.prod;
            state.minWageActive = false;
            
            // Text sicher einfügen
            document.getElementById('round-current').textContent = state.round;
            document.getElementById('year-label').textContent = scen.name;
            document.getElementById('infl-val').textContent = state.inflation.toFixed(1) + "%";
            document.getElementById('prod-val').textContent = state.productivity.toFixed(1) + "%";
            
            // Reset Eingaben
            ui.wageInput.value = 0.0;
            ui.wageOutput.textContent = "0.0%";
            ui.userInput.value = ""; 
            ui.userInput.classList.remove('border-red-300', 'border-green-200'); 
            ui.feedback.textContent = "";
            
            // Reset Mindestlohn-Button
            ui.minWageBtn.textContent = "Nein, Autonomie wahren";
            ui.minWageBtn.style.background = "var(--bg-slate-100)";
            ui.minWageBtn.style.color = "var(--text-slate-500)";
            ui.minWageInfo.classList.add('hidden');

            updateBars();
            startTimer();
        }

        // Slider Event
        ui.wageInput.addEventListener('input', (e) => {
            // Sicherstellen, dass es eine Zahl ist
            let val = parseFloat(e.target.value);
            if (isNaN(val)) val = 0.0;
            ui.wageOutput.textContent = val.toFixed(1) + "%";
        });

        // Mindestlohn Toggle
        function toggleMinWage() {
            state.minWageActive = !state.minWageActive;
            if(state.minWageActive) {
                ui.minWageBtn.textContent = "Ja, Mindestlohn erhöhen";
                ui.minWageBtn.style.background = "var(--color-yellow-500)";
                ui.minWageBtn.style.color = "white";
                ui.minWageInfo.classList.remove('hidden');
            } else {
                ui.minWageBtn.textContent = "Nein, Autonomie wahren";
                ui.minWageBtn.style.background = "var(--bg-slate-100)";
                ui.minWageBtn.style.color = "var(--text-slate-500)";
                ui.minWageInfo.classList.add('hidden');
            }
        }

        function updateBars() {
            document.getElementById('peace-val').textContent = Math.round(state.socialPeace) + "%";
            document.getElementById('bar-peace').style.width = state.socialPeace + "%";
            document.getElementById('comp-val').textContent = Math.round(state.competitiveness) + "%";
            document.getElementById('bar-comp').style.width = state.competitiveness + "%";
            document.getElementById('unemp-val').textContent = state.outsiderUnemployment.toFixed(1) + "%";
            
            let bw = (state.outsiderUnemployment / 20) * 100;
            if(bw > 100) bw = 100;
            document.getElementById('bar-unemp').style.width = bw + "%";
        }

        function startTimer() {
            if (!CONFIG.ENABLE_TIMER_LOG) return;
            state.startTime = Date.now();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - state.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                ui.timer.textContent = `${m}:${s}`;
            }, 1000);
        }

        /**
         * Validiert und berechnet die Runde
         */
        function commitRound() {
            clearInterval(timerInterval);
            const duration = CONFIG.ENABLE_TIMER_LOG ? Math.floor((Date.now() - state.startTime) / 1000) : 0;
            
            // 1. Validierung der Schüler-Berechnung
            // Schutz vor extremen Werten oder Fehleingaben
            let userEst = parseFloat(ui.userInput.value);
            
            // Trolling-Schutz: Werte klemmen oder NaN behandeln
            if (isNaN(userEst)) {
                userEst = null; 
            } else if (userEst > CONFIG.MAX_VAL_CHECK) {
                userEst = CONFIG.MAX_VAL_CHECK; // Klemmen
            } else if (userEst < CONFIG.MIN_VAL_CHECK) {
                userEst = CONFIG.MIN_VAL_CHECK; // Klemmen
            }

            const realNeutral = state.inflation + state.productivity;
            let calcMsg = "";
            let calcCorrect = false;

            if (userEst === null) {
                calcMsg = "⚠️ Du hast den Spielraum nicht berechnet.";
            } else if (Math.abs(userEst - realNeutral) < 0.15) {
                calcMsg = "✅ Korrekt gerechnet! (Spielraum: " + realNeutral.toFixed(1) + "%)";
                calcCorrect = true;
            } else {
                calcMsg = "❌ Falsch gerechnet. Richtig wäre " + realNeutral.toFixed(1) + "% (Inf+Prod).";
            }

            // 2. Auswertung Lohn (Slider ist technisch geklemmt durch min/max Attribut, aber sicherheitshalber...)
            let wage = parseFloat(ui.wageInput.value);
            if (isNaN(wage)) wage = 0;
            wage = Math.min(Math.max(wage, 0), 8); // Sicherstellen: 0-8

            const diff = wage - realNeutral;
            let res = { u: "", e: "", m: "", sum: "" };

            // Logik-Zweig (M11)
            if (diff > 0.8) {
                state.socialPeace += 3; state.competitiveness -= 12; state.outsiderUnemployment += 0.4;
                res.u = "Jubel! Aber hält das an?";
                res.e = "Zu teuer! Arbeitsplätze in Gefahr.";
                res.m = "Inflation steigt (Lohn-Preis-Spirale).";
                res.sum = "Lohn > Spielraum";
            } else if (diff < -0.8) {
                state.socialPeace -= 15; state.competitiveness += 5;
                res.u = "Streik! Reallohnverlust!";
                res.e = "Gut für die Kosten.";
                res.m = "Kaufkraft bricht ein.";
                res.sum = "Lohn < Spielraum";
            } else {
                state.socialPeace += 2; state.competitiveness += 2;
                res.u = "Akzeptabel.";
                res.e = "Tragbar.";
                res.m = "Stabilität.";
                res.sum = "Verteilungsneutral";
            }

            // 3. Mindestlohn Effekt (M12/M13)
            if(state.minWageActive) {
                state.socialPeace += 5;
                state.outsiderUnemployment += 2.0; 
                state.competitiveness -= 4;
                res.m += " Mindestlohn verdrängt Outsider (M13).";
            }

            // Werte klemmen (Verhindert Absturz der Anzeige)
            state.socialPeace = Math.min(100, Math.max(0, state.socialPeace));
            state.competitiveness = Math.min(100, Math.max(0, state.competitiveness));
            state.outsiderUnemployment = Math.min(25, Math.max(0, state.outsiderUnemployment)); // Max 25% AL

            // Loggen für Endscreen
            state.history.push({
                round: state.round,
                scen: scenarios[state.round-1].name,
                infl: state.inflation,
                prod: state.productivity,
                neutral: realNeutral,
                userCalc: userEst === null ? "-" : userEst,
                calcStatus: calcCorrect ? "Richtig" : "Falsch",
                wage: wage,
                minW: state.minWageActive ? "Ja" : "Nein",
                dur: duration,
                resPeace: state.socialPeace,
                resComp: state.competitiveness,
                resUnemp: state.outsiderUnemployment
            });

            // Modal Anzeigen (Sicher via textContent)
            const modalCalcFb = document.getElementById('calc-feedback-modal');
            modalCalcFb.style.display = 'block';
            modalCalcFb.textContent = calcMsg;
            modalCalcFb.style.background = calcCorrect ? "var(--color-green-50)" : "var(--color-red-100)";
            modalCalcFb.style.color = calcCorrect ? "var(--color-green-700)" : "var(--color-red-800)";

            document.getElementById('res-union').textContent = res.u;
            document.getElementById('res-employer').textContent = res.e;
            document.getElementById('res-market').textContent = res.m;
            document.getElementById('modal').style.display = 'flex';
        }

        function nextRound() {
            document.getElementById('modal').style.display = 'none';
            state.round++;
            if(state.round > state.maxRounds) showEndScreen();
            else loadRound();
        }

        /**
         * Zeigt den Abschlussbericht sicher an.
         * VERWENDET KEIN INNERHTML, um XSS zu verhindern.
         */
        function showEndScreen() {
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('end-screen').style.display = 'block';
            
            const list = document.getElementById('history-list');
            list.innerHTML = ''; // Leeren (sicher, da leer)

            // DOM-Elemente für jeden Log-Eintrag erstellen
            state.history.forEach(h => {
                const row = document.createElement('div');
                row.style.cssText = "background: var(--bg-slate-50); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--bg-slate-200); font-size: 0.9rem;";

                // Header Zeile
                const header = document.createElement('div');
                header.style.cssText = "display: flex; justify-content: space-between; margin-bottom: 0.5rem; border-bottom: 1px solid var(--bg-slate-200); padding-bottom: 0.5rem;";
                
                const title = document.createElement('strong');
                title.style.color = "var(--text-slate-800)";
                title.textContent = `Runde ${h.round}: ${h.scen}`;
                
                const time = document.createElement('span');
                time.style.cssText = "color: var(--text-slate-500); font-size: 0.8rem;";
                time.textContent = CONFIG.ENABLE_TIMER_LOG ? `${h.dur}s` : "";

                header.appendChild(title);
                header.appendChild(time);
                row.appendChild(header);

                // Grid für Details
                const grid = document.createElement('div');
                grid.style.cssText = "display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;";

                // Linke Spalte (Szenario)
                const col1 = document.createElement('div');
                col1.innerHTML = `<div style="font-size: 0.75rem; color: var(--text-slate-500); text-transform: uppercase; font-weight: bold;">Szenario</div>`;
                const col1Line1 = document.createElement('div');
                col1Line1.textContent = `Infl: ${h.infl.toFixed(1)}% | Prod: ${h.prod.toFixed(1)}%`;
                const col1Line2 = document.createElement('div');
                col1Line2.textContent = `Ziel (Neutral): ${h.neutral.toFixed(1)}%`;
                col1.appendChild(col1Line1);
                col1.appendChild(col1Line2);

                // Rechte Spalte (Wahl)
                const col2 = document.createElement('div');
                col2.innerHTML = `<div style="font-size: 0.75rem; color: var(--text-slate-500); text-transform: uppercase; font-weight: bold;">Deine Wahl</div>`;
                const col2Line1 = document.createElement('div');
                col2Line1.textContent = `Rechnung: ${h.userCalc} (${h.calcStatus})`;
                const col2Line2 = document.createElement('div');
                col2Line2.textContent = `Lohn: ${h.wage.toFixed(1)}% | Mindestlohn: ${h.minW}`;
                col2.appendChild(col2Line1);
                col2.appendChild(col2Line2);

                grid.appendChild(col1);
                grid.appendChild(col2);
                row.appendChild(grid);

                // Ergebnisse Zeile
                const resRow = document.createElement('div');
                resRow.style.cssText = "background: white; padding: 0.5rem; border-radius: 0.25rem; border: 1px solid var(--bg-slate-100);";
                
                const resHeader = document.createElement('div');
                resHeader.style.cssText = "font-size: 0.75rem; color: var(--text-slate-500); text-transform: uppercase; font-weight: bold; margin-bottom: 0.25rem;";
                resHeader.textContent = "Ergebnis-Werte";
                
                const resVals = document.createElement('div');
                resVals.style.cssText = "display: flex; justify-content: space-between; font-size: 0.85rem;";
                
                // Helfer für Farbspan
                const createSpan = (txt, color) => {
                    const s = document.createElement('span');
                    s.style.color = color;
                    s.textContent = txt;
                    return s;
                };

                resVals.appendChild(createSpan(`Frieden: ${Math.round(h.resPeace)}%`, "var(--color-indigo-500)"));
                resVals.appendChild(createSpan(`Wettbewerb: ${Math.round(h.resComp)}%`, "var(--color-amber-500)"));
                resVals.appendChild(createSpan(`Arbeitslose: ${h.resUnemp.toFixed(1)}%`, "var(--color-red-600)"));

                resRow.appendChild(resHeader);
                resRow.appendChild(resVals);
                row.appendChild(resRow);

                list.appendChild(row);
            });

            const verdict = document.getElementById('final-summary');
            if(state.socialPeace > 60 && state.outsiderUnemployment < 8) {
                verdict.textContent = "Glückwunsch! Ein guter Kompromiss.";
                verdict.style.color = "var(--color-green-700)";
            } else {
                verdict.textContent = "Schwierig! Arbeitslosigkeit oder Unruhe sind zu hoch.";
                verdict.style.color = "var(--color-red-600)";
            }
        }
    </script>
</body>
</html>
